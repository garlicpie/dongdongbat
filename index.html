<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Slot</title>
<style>
  :root{
    --bg:#000;
    --gold1:#fff89a; --gold2:#ffe14b; --gold3:#ffd100; --gold4:#c99600;
    --reelW:110px; --reelH:130px; --gap:14px;       /* ìŠ¬ë¡¯ ì¡°ê¸ˆ ë” ì‘ê²Œ */
    --boxRadius:12px;
  }
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:#fff;overflow:hidden;
    font-family:"Noto Sans","Noto Sans KR","Noto Color Emoji",ui-sans-serif,system-ui,Segoe UI,Roboto,sans-serif;
    display:grid;place-items:center;
  }
  .wrap{position:relative;width:100vw;height:100vh}

  /* ì¤‘ì•™ ìŠ¬ë¡¯ ìº”ë²„ìŠ¤(ê·¸ë¦¼ì€ ìº”ë²„ìŠ¤ì—ì„œ, íƒ­ ì˜ì—­ì€ í™”ë©´ ì „ì²´) */
  #slot{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);image-rendering:auto}

  /* ëˆ(ìˆ«ìë§Œ) â€” ìë¦¬ìˆ˜ë³„ ì „í™˜ì„ ìœ„í•´ ì»¨í…Œì´ë„ˆ */
  .money-wrap{
    position:absolute;top:20px;left:50%;transform:translateX(-50%);
    display:flex;gap:2px;align-items:center;user-select:none;
    font-weight:1000;font-size:clamp(28px,6vw,52px);letter-spacing:.5px;
    background:linear-gradient(180deg,var(--gold1),var(--gold2) 40%,var(--gold3) 70%,var(--gold4));
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 2px 0 rgba(0,0,0,.55),0 10px 26px rgba(255,224,0,.28);
  }
  .digit{
    position:relative;display:inline-block;min-width:0.6em;text-align:center;
  }
  .digit .old,.digit .new{
    position:absolute;left:0;right:0;top:0;will-change:transform,opacity;
  }
  .digit .old{animation:fallOut .25s ease forwards}
  .digit .new{transform:translateY(-0.9em);opacity:0;animation:fallIn .25s ease forwards}
  @keyframes fallOut{from{transform:translateY(0);opacity:1}to{transform:translateY(0.9em);opacity:0}}
  @keyframes fallIn {from{transform:translateY(-0.9em);opacity:0}to{transform:translateY(0);opacity:1}}

  /* JACKPOT FX */
  .fx{ position:absolute;inset:0;pointer-events:none; }
  .jackpot{
    position:absolute;inset:0;display:grid;place-items:center;opacity:0;visibility:hidden;transition:opacity .25s;
  }
  .jackpot.show{opacity:1;visibility:visible}
  .jackpot .txt{
    font-size:clamp(52px,12vw,140px);font-weight:1000;color:#ff1a1a;letter-spacing:.02em;
    text-shadow:0 10px 36px rgba(255,0,0,.55),0 2px 0 #300;animation:thump .9s cubic-bezier(.2,1.2,.2,1) 2;
    font-family:"Noto Sans","Noto Sans KR",sans-serif;
  }
  @keyframes thump{0%{transform:scale(.82)}50%{transform:scale(1.12)}100%{transform:scale(1)}}
  .rainbow{
    position:absolute;inset:-25vmax;z-index:-1;opacity:0;filter:blur(10px) saturate(1.2);
    background:conic-gradient(from 0deg,red,orange,yellow,green,cyan,blue,violet,red);
    mask:radial-gradient(closest-side,rgba(255,255,255,.95),transparent 70%);
    transform:scale(.85) rotate(0deg);
  }
  .rainbow.show{ animation:spin 1.6s linear infinite, pulse 1.6s ease-in-out infinite alternate; opacity:.9 }
  @keyframes spin{to{transform:scale(1.05) rotate(360deg)}}
  @keyframes pulse{from{opacity:.6}to{opacity:.93}}

  /* ì½˜ì†” ì…ë ¥ */
  .console{ position:absolute;left:50%;bottom:22px;transform:translateX(-50%);width:min(680px,92vw);display:none; }
  .console.show{display:block}
  .console input{
    width:100%;padding:12px 14px;border-radius:10px;border:1px solid #333;outline:none;color:#fff;background:#0d0d0d;
    box-shadow:0 6px 20px rgba(0,0,0,.5), inset 0 0 0 2px rgba(255,255,255,.03);
    font-size:16px;letter-spacing:.3px;
    font-family:"Noto Sans","Noto Sans KR",sans-serif;
  }

  /* DEV íŒ¨ë„: ìŠ¬ë¡¯ì„ ê°€ë¦¬ì§€ ì•Šë„ë¡ ì¢Œí•˜ë‹¨ ë„í‚¹(ì‘ê²Œ) */
  .dev{
    position:absolute;left:12px;bottom:12px;max-width:min(520px,44vw);max-height:36vh;overflow:auto;
    background:#0b0b0b;border:1px solid #2a2a2a;border-radius:12px;padding:10px 12px;color:#ddd;
    font: 12.5px/1.45 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    display:none; z-index:3;
    box-shadow:0 8px 28px rgba(0,0,0,.5);
  }
  .dev.show{display:block}
  .dev h3{margin:.2em 0 .4em;font-size:13.5px;color:#ffe14b;font-family:"Noto Sans","Noto Sans KR",sans-serif;}
  .dev table{width:100%;border-collapse:collapse;margin:6px 0 8px}
  .dev th,.dev td{border-bottom:1px solid #222;padding:4px 6px;text-align:left}
  .dev .muted{opacity:.7}
</style>
</head>
<body>
<div class="wrap" id="app" aria-label="tap anywhere">
  <canvas id="slot" width="400" height="150" aria-label="slot"></canvas>

  <!-- ëˆ (ìë¦¬ìˆ˜ë³„ ë Œë”ë§) -->
  <div class="money-wrap" id="moneyWrap" aria-live="polite"></div>

  <!-- FX -->
  <div class="fx">
    <div class="rainbow" id="rainbow"></div>
    <div class="jackpot" id="jackpot"><div class="txt">JACKPOT!</div></div>
  </div>

  <!-- ì½˜ì†” -->
  <div class="console" id="console"><input id="cmd" type="text" spellcheck="false" autocomplete="off" placeholder="/777, /dev, /devoff"/></div>

  <!-- DEV -->
  <div class="dev" id="devPanel">
    <h3>DEV</h3>
    <div id="rules"></div>
    <div id="rtp" style="margin:6px 0 4px"></div>
    <div class="muted">Logs (latest 30)</div>
    <table id="logs"><thead><tr><th>time</th><th>sym</th><th>bet</th><th>payout</th><th>delta</th><th>bank</th><th>note</th></tr></thead><tbody></tbody></table>
  </div>
</div>

<script>
(()=> {
  /* ================= CONFIG (ì˜ë¬¸ í‘œê¸°ë§Œ ë…¸ì¶œ) ================= */
  const CFG = {
    reels: 3,
    reelW: 110, reelH: 130, gap: 14,                // ìš”ì²­: ì¡°ê¸ˆ ë” ì‘ê²Œ + ë¦¬ì–¼ ë°•ìŠ¤ëŠ” ìº”ë²„ìŠ¤ì—ì„œ ê·¸ë¦¼
    cost: 100,                                       // bet per spin (ìŒìˆ˜ í—ˆìš©)
    // ê°€ì¤‘ì¹˜(í™•ë¥ ) â€” ê°’ì´ í´ìˆ˜ë¡ ìì£¼ ë“±ì¥
    weights: { "ğŸ’":6, "ğŸ‹":6, "â­":3, "7":1, "ğŸ’":2, "ğŸ””":4, "ğŸ€":5, "ğŸ‡":6 },
    // ë°°ë‹¹(ë°°ìˆ˜)
    pay3:    { "7":1000, "ğŸ’":200, "â­":80, "ğŸ””":30, "ğŸ€":20, "ğŸ’":10, "ğŸ‹":8, "ğŸ‡":6 },
    pay2:    { "7":25,   "ğŸ’":6,   "â­":3,  "ğŸ””":2,  "ğŸ€":2,  "ğŸ’":2,  "ğŸ‹":2, "ğŸ‡":2 },
    /* ìŠ¤í•€/ì •ì§€ ë™ì‘ */
    spinCellsPerSec: 18,       // íšŒì „ ì†ë„(ì´ˆë‹¹ ì…€ ìˆ˜) â€” ë“±ì†
    stopStagger: 420,          // ë¦´ ì •ì§€ ì‹œì‘ ê°„ê²©(ms) â€” ì¢Œâ†’ìš° ìˆœì°¨
    stopDuration: 900,         // ê° ë¦´ì´ ì •ì§€ì— ê±¸ë¦¬ëŠ” ì‹œê°„(ms) â€” ëª¨ë‘ ë™ì¼(ìš”ì²­ì‚¬í•­)
    extraTurns: 2,             // ì •ì§€ ì‹œì‘ í›„ ì¶”ê°€ë¡œ ë„ëŠ” ë°”í€´ ìˆ˜(ê³ ì •, ëœë¤ X)
    cellPadRatio: 0.14         // ì…€ ì•ˆìª½ ì—¬ë°±(ì´ëª¨ì§€ ì‘ê²Œ ë³´ì´ë„ë¡)
  };

  /* ================= STATE ================= */
  const el = {
    cvs: document.getElementById('slot'),
    app: document.getElementById('app'),
    moneyWrap: document.getElementById('moneyWrap'),
    console: document.getElementById('console'),
    cmd: document.getElementById('cmd'),
    jp: document.getElementById('jackpot'),
    rb: document.getElementById('rainbow'),
    dev: document.getElementById('devPanel'),
    rules: document.getElementById('rules'),
    rtp: document.getElementById('rtp'),
    logs: document.querySelector('#logs tbody'),
  };
  const ctx = el.cvs.getContext('2d');

  /* DPR/ìº”ë²„ìŠ¤ í¬ê¸° */
  function sizeCanvas(){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
    const W = CFG.reelW*CFG.reels + CFG.gap*(CFG.reels-1);
    const H = CFG.reelH;
    el.cvs.style.width = W+'px'; el.cvs.style.height = H+'px';
    el.cvs.width = Math.floor(W*dpr); el.cvs.height = Math.floor(H*dpr);
    return dpr;
  }
  let DPR = sizeCanvas();
  window.addEventListener('resize', ()=>{ DPR=sizeCanvas(); drawStatic(); });

  /* SYMBOLS & SHEET (ì„¸ë¡œ ì‹œíŠ¸, ì •ì‚¬ê° ì…€) */
  const SYMBOLS = ["ğŸ’","ğŸ‹","â­","7","ğŸ’","ğŸ””","ğŸ€","ğŸ‡"];
  const IDX = Object.fromEntries(SYMBOLS.map((s,i)=>[s,i]));
  const N = SYMBOLS.length;

  function makeSheet(){
    const px = Math.max(220, Math.floor(CFG.reelH*1.9)); // ê³ í•´ìƒë„ â†’ ì¶•ì†Œ
    const cnv = document.createElement('canvas'); cnv.width = px; cnv.height = px*N;
    const c = cnv.getContext('2d');
    c.textAlign='center'; c.textBaseline='middle';
    for(let i=0;i<N;i++){
      const cy = i*px + px/2;
      if(SYMBOLS[i]==="7"){
        c.font = `900 ${Math.floor(px*0.66)}px "Noto Sans","Noto Sans KR",sans-serif`;
        c.fillStyle='#fff';
        c.lineWidth = Math.max(2, px*0.02); c.strokeStyle='rgba(0,0,0,.45)';
        c.strokeText('7', px/2, cy);
        c.fillText('7', px/2, cy);
      }else{
        c.font = `${Math.floor(px*0.74)}px "Noto Color Emoji","Noto Sans",sans-serif`;
        c.fillText(SYMBOLS[i], px/2, cy);
      }
    }
    return {sheet:cnv, px};
  }
  const SPR = makeSheet();

  /* ë¦´(ì…€ ë‹¨ìœ„ ìœ„ì¹˜) */
  const reels = Array.from({length:CFG.reels}, ()=>({
    pos: Math.random()*N,            // í˜„ì¬ ìœ„ì¹˜(ì…€ ë‹¨ìœ„, ì†Œìˆ˜ ê°€ëŠ¥)
    startPos: 0, targetPos: 0,       // ì •ì§€ ì¸í„°í´ë ˆì´ì…˜ìš©
    stopStart: null, stopEnd: null,  // ì •ì§€ êµ¬ê°„ ì‹œê°„
    stopping:false, stopped:true
  }));

  let bank = 10000;             // ìŒìˆ˜ í—ˆìš©
  let state = 'idle';           // idle | spinning | stopping
  let lastT = 0;
  let rAF = 0;
  let planIdx = null;           // ì •ì§€ ì‹œ í™•ì •í•  ê²°ê³¼(ë‹¤ì‹œ ëˆ„ë¥¼ ë•Œ ê²°ì •)
  let devMode = false;

  /* ==== MONEY (ìë¦¬ìˆ˜ë³„ ì• ë‹ˆë©”ì´ì…˜) ==== */
  function renderMoneyDigits(num){
    const s = num.toLocaleString();
    // ì²˜ìŒ ë Œë” or ê¸¸ì´ê°€ ë°”ë€Œë©´ ì „ì²´ ë¦¬ë¹Œë“œ
    if(!el.moneyWrap.dataset.text || el.moneyWrap.dataset.text.length !== s.length){
      el.moneyWrap.innerHTML = '';
      for(const ch of s){
        const span = document.createElement('span');
        span.className='digit';
        span.textContent = ch;
        el.moneyWrap.appendChild(span);
      }
      el.moneyWrap.dataset.text = s;
      return;
    }
    // ìë¦¬ìˆ˜ ë¹„êµ â†’ ë‹¬ë¼ì§„ ìë¦¬ë§Œ êµì²´ ì• ë‹ˆë©”ì´ì…˜
    const prev = el.moneyWrap.dataset.text;
    const nodes = Array.from(el.moneyWrap.children);
    for(let i=0;i<s.length;i++){
      if(prev[i]===s[i]) continue;
      const cell = nodes[i];
      const old = document.createElement('span'); old.className='old'; old.textContent = prev[i];
      const neu = document.createElement('span'); neu.className='new'; neu.textContent = s[i];
      cell.innerHTML=''; cell.appendChild(old); cell.appendChild(neu);
      // 260ms í›„ ê³ ì • í…ìŠ¤íŠ¸ë¡œ êµì²´
      setTimeout(()=>{ cell.textContent = s[i]; }, 260);
    }
    el.moneyWrap.dataset.text = s;
  }
  function setMoney(v, animate=true){
    const from = bank; bank = v;
    if(!animate){ renderMoneyDigits(bank); return; }
    // ë¹ ë¥¸ ê³„ë‹¨ìƒìŠ¹ ëŠë‚Œ: ì°¨ì´ê°€ ì‘ì„ìˆ˜ë¡ step=1, í´ìˆ˜ë¡ stepâ†‘
    const diff = Math.abs(bank - from);
    const dir = bank>from ? 1 : -1;
    let cur = from;
    const t0 = performance.now();
    function step(now){
      const elapsed = now - t0;
      // 220~420ms ë‚´ì— ìˆ˜ë ´ë˜ë„ë¡ ìŠ¤í… ê³„ì‚°
      const targetDur = Math.min(420, Math.max(220, diff*2));
      const p = Math.min(1, elapsed/targetDur);
      // ì§€ìˆ˜ ê°€ì†ìœ¼ë¡œ ì†ë„ê°
      const eased = p*p;
      const est = from + Math.round((bank - from)*eased);
      // ìµœì†Œ 1ì”©ì€ ì§„í–‰
      if(est===cur && cur!==bank) cur += dir;
      else cur = est;
      renderMoneyDigits(cur);
      if(cur!==bank) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  /* ==== ë°°ë‹¹ ê³„ì‚° / RTP ==== */
  function payoutFor(indices){
    const sym = indices.map(i=>SYMBOLS[i]);
    const counts = {}; sym.forEach(s=>counts[s]=(counts[s]||0)+1);
    let multi = 0;
    for(const s of Object.keys(counts)){ if(counts[s]===3){ multi = (CFG.pay3[s]||0); break; } }
    if(multi===0){ for(const s of Object.keys(counts)){ if(counts[s]===2){ multi = (CFG.pay2[s]||0); break; } } }
    return {multiplier:multi, symbols:sym};
  }
  function calcRTP(){
    const w = SYMBOLS.map(s=>CFG.weights[s]||0);
    const sum = w.reduce((a,b)=>a+b,0);
    const p = w.map(x=>x/sum);
    let rtp = 0;
    for(let i=0;i<N;i++) rtp += (CFG.pay3[SYMBOLS[i]]||0) * Math.pow(p[i],3);
    for(let i=0;i<N;i++) rtp += (CFG.pay2[SYMBOLS[i]]||0) * (3 * Math.pow(p[i],2) * (1-p[i]));
    return rtp;
  }

  /* ==== ê²°ê³¼ ë½‘ê¸°(ì •ì§€ ì‹œì ì— í™•ì •) ==== */
  function pickOutcome(forced=null){
    if(forced) return forced.slice();
    const bag = SYMBOLS.map(s=>({s,w:CFG.weights[s]}));
    const sum = bag.reduce((a,b)=>a+b.w,0);
    const pick = ()=>{
      let x = Math.random()*sum;
      for(const it of bag){ if((x-=it.w)<0) return IDX[it.s]; }
      return IDX[bag[bag.length-1].s];
    };
    return [pick(),pick(),pick()];
  }

  /* ==== ê·¸ë¦¼ ë„ìš°ë¯¸ ==== */
  function rrect(x,y,w,h,r){
    const k = Math.min(r,w/2,h/2);
    ctx.beginPath();
    ctx.moveTo(x+k,y);
    ctx.arcTo(x+w,y,x+w,y+h,k);
    ctx.arcTo(x+w,y+h,x,y+h,k);
    ctx.arcTo(x,y+h,x,y,k);
    ctx.arcTo(x,y,x+w,y,k);
    ctx.closePath();
  }

  function drawReel(i){
    const rw = Math.floor(CFG.reelW*DPR), rh = Math.floor(CFG.reelH*DPR), gap = Math.floor(CFG.gap*DPR);
    const totalW = rw*CFG.reels + gap*(CFG.reels-1);
    const x0 = Math.floor((el.cvs.width - totalW)/2) + i*(rw+gap);
    const y0 = Math.floor((el.cvs.height - rh)/2);
    const r = reels[i];

    // ì™¸ê³½ ë°•ìŠ¤ + í´ë¦½
    ctx.save();
    rrect(x0,y0,rw,rh,Math.floor(12*DPR));
    ctx.fillStyle='#101010'; ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,.06)'; ctx.lineWidth=2*DPR; ctx.stroke();
    ctx.clip();

    // ìŠ¤í”„ë¼ì´íŠ¸ ê·¸ë¦¬ê¸° (ì •ì‚¬ê° ì†ŒìŠ¤ â†’ ë¹„ìœ¨ ìœ ì§€, ì¤‘ì•™ ë°°ì¹˜)
    const pad = Math.floor(CFG.reelH*CFG.cellPadRatio)*DPR;
    const viewH = rh - pad*2;
    const s = Math.floor(Math.min(rw, viewH) * 0.76);  // ì‘ê²Œ
    const dx = x0 + Math.floor((rw - s)/2);
    // í˜„ì¬ ì…€ ìœ„ì¹˜
    const off = ((r.pos%N)+N)%N;
    const base = Math.floor(off);
    const shift = (off - base)*CFG.reelH*DPR;

    for(let k=-1;k<=2;k++){
      const idx = (base + k + N) % N;
      const sy = idx * SPR.px;
      const dyTop = y0 + (k*CFG.reelH)*DPR - Math.floor(shift) + pad + Math.floor((viewH - s)/2);
      ctx.drawImage(SPR.sheet, 0, sy, SPR.px, SPR.px, dx, dyTop, s, s);
    }
    ctx.restore();
  }

  function drawAll(){
    ctx.clearRect(0,0,el.cvs.width,el.cvs.height);
    for(let i=0;i<reels.length;i++) drawReel(i);
  }

  /* ==== JACKPOT ==== */
  function showJackpot(){
    el.jp.classList.add('show'); el.rb.classList.add('show');
    setTimeout(()=>{ el.jp.classList.remove('show'); el.rb.classList.remove('show'); }, 1800);
  }

  /* ==== ë£¨í”„ ==== */
  function loop(t){
    if(!lastT) lastT = t;
    const dt = Math.min(50, t - lastT)/1000; // sec
    lastT = t;

    let allStopped = true;
    const v = CFG.spinCellsPerSec * dt;

    for(let i=0;i<reels.length;i++){
      const r = reels[i];

      if(state==='spinning'){
        r.pos += v; r.stopped=false; allStopped=false;
      }else if(state==='stopping'){
        if(!r.stopping){                   // ì•„ì§ ê°ì† ì‹œì‘ ì „
          if(t >= (r.stopStart||Infinity)){
            // ì •ì§€ êµ¬ê°„ ì„¤ì •(ê³ ì • ì‹œê°„)
            r.stopping = true;
            r.startPos = r.pos;
            const cur = ((r.startPos%N)+N)%N;
            const idx = planIdx[i];
            const diff = (idx - cur + N) % N;
            const total = diff + CFG.extraTurns*N;
            r.targetPos = r.startPos + total;
            r.stopEnd = r.stopStart + CFG.stopDuration;
          }else{
            r.pos += v;
            allStopped=false;
          }
        }
        if(r.stopping){
          const p = Math.min(1, (t - r.stopStart) / CFG.stopDuration);
          // ë¶€ë“œëŸ¬ìš´ ê°ì†(ê³ ì • ì‹œê°„)
          const ease = 1 - Math.pow(1 - p, 3); // easeOutCubic
          r.pos = r.startPos + ease * (r.targetPos - r.startPos);
          if(p < 1){ r.stopped=false; allStopped=false; }
          else { r.pos = r.targetPos; r.stopped = true; }
        }
      }
    }

    drawAll();

    if(!allStopped){ rAF = requestAnimationFrame(loop); return; }
    // ëª¨ë‘ ì •ì§€ â†’ ì •ì‚°
    rAF = 0; state='idle';
    settle();
  }

  /* ==== ì…ë ¥: í™”ë©´ ì „ì²´ íƒ­ / Space / ì½˜ì†” ==== */
  function startSpin(){
    if(state!=='idle') return;
    setMoney(bank - CFG.cost, true); // ìŒìˆ˜ í—ˆìš©
    state='spinning'; lastT=0;
    if(!rAF) rAF = requestAnimationFrame(loop);
  }
  function beginStop(force777=false){
    if(state!=='spinning') return;
    // ê²°ê³¼ëŠ” "ì •ì§€ ë²„íŠ¼ì„ ëˆ„ë¥¸ ìˆœê°„" í™•ì •
    planIdx = force777 ? [IDX['7'],IDX['7'],IDX['7']] : pickOutcome();
    state='stopping';
    const t0 = performance.now();
    reels.forEach((r,i)=>{ r.stopStart = t0 + CFG.stopStagger*i; r.stopping=false; });
  }

  // ì „ì²´ í™”ë©´ íƒ­ (ì½˜ì†”/DEV í´ë¦­ì€ ì œì™¸)
  el.app.addEventListener('pointerdown', (e)=>{
    const ignore = e.target.closest('.console,.dev,#cmd');
    if(ignore) return;
    if(state==='idle') startSpin();
    else if(state==='spinning') beginStop(false);
  });
  // Space: í† ê¸€
  window.addEventListener('keydown', (e)=>{
    if(e.code==='Space'){
      const isInput = document.activeElement && (document.activeElement.tagName==='INPUT' || document.activeElement.tagName==='TEXTAREA' || document.activeElement.isContentEditable);
      if(isInput) return;
      e.preventDefault();
      if(state==='idle') startSpin(); else if(state==='spinning') beginStop(false);
    }
    if(e.key==='/'){ e.preventDefault(); openConsole(); }
  });

  /* ==== ì½˜ì†” ëª…ë ¹ ==== */
  function openConsole(){ el.console.classList.add('show'); el.cmd.value='/'; el.cmd.focus(); el.cmd.setSelectionRange(el.cmd.value.length,el.cmd.value.length); }
  function closeConsole(){ el.console.classList.remove('show'); el.cmd.blur(); }

  el.cmd.addEventListener('keydown',(e)=>{
    if(e.key==='Escape'){ e.preventDefault(); closeConsole(); return; }
    if(e.key==='Enter'){ e.preventDefault(); const v = el.cmd.value.trim(); runCommand(v); el.cmd.value=''; closeConsole(); }
  });

  function runCommand(cmd){
    if(cmd==='/dev'){ devMode=true; updateDev(true); return; }
    if(cmd==='/devoff'){ devMode=false; updateDev(false); return; }
    if(cmd==='/777'){
      if(state==='idle'){ startSpin(); setTimeout(()=>{ if(state==='spinning') beginStop(true); }, 260); }
      else if(state==='spinning'){ beginStop(true); }
      return;
    }
  }

  /* ==== ì •ì‚°/ë¡œê·¸/DEV ==== */
  const logs = [];
  function settle(){
    const idx = reels.map(r => {
      let k = Math.round(r.pos) % N; if(k<0) k+=N; return k;
    });
    const info = payoutFor(idx);
    const bet = CFG.cost;
    const payout = bet * (info.multiplier||0);
    const delta = -bet + payout;
    setMoney(bank + payout, true);

    if(info.multiplier>=1000 && info.symbols.every(s=>s==='7')) showJackpot();

    logs.unshift({
      t:new Date().toLocaleTimeString(),
      sym:info.symbols.join(' '),
      bet,payout,delta,bank,
      note: (info.multiplier>=1000 && info.symbols[0]==='7' && info.symbols[1]==='7' && info.symbols[2]==='7')?'JACKPOT':''
    });
    if(logs.length>30) logs.pop();
    updateDev();
    planIdx=null;
  }

  function updateDev(toggle){
    if(toggle!==undefined) el.dev.classList.toggle('show', !!toggle);
    else el.dev.classList.toggle('show', devMode);
    if(!devMode) return;

    // ê·œì¹™/ë°°ë‹¹/í™•ë¥ 
    const w = SYMBOLS.map(s=>({s, w:CFG.weights[s]}));
    const sum = w.reduce((a,b)=>a+b.w,0);
    const p = w.map(o=>o.w/sum);
    const pay3 = SYMBOLS.map(s=>`${s}Ã—3:x${CFG.pay3[s]||0}`).join('  |  ');
    const pay2 = SYMBOLS.map(s=>`${s}Ã—2:x${CFG.pay2[s]||0}`).join('  |  ');
    el.rules.innerHTML = `
      <div><b>weights</b> â†’ ${SYMBOLS.map((s,i)=>`${s}:${CFG.weights[s]} (p=${p[i].toFixed(3)})`).join('  Â·  ')}</div>
      <div style="margin-top:6px"><b>payout 3</b> â†’ ${pay3}</div>
      <div><b>payout 2</b> â†’ ${pay2}</div>
      <div class="muted" style="margin-top:4px">line: middle only, reels independent; randomness locked when you press stop</div>
    `;
    const rtp = calcRTP();
    el.rtp.textContent = `RTPâ‰ˆ ${(rtp*100).toFixed(2)}% (bet=1 baseline)`;

    el.logs.innerHTML = logs.map(L=>(
      `<tr>
         <td class="muted">${L.t}</td>
         <td>${L.sym}</td>
         <td>${L.bet.toLocaleString()}</td>
         <td>${L.payout.toLocaleString()}</td>
         <td style="color:${L.delta>=0?'#69f169':'#ff6b6b'}">${L.delta>=0?'+':''}${L.delta.toLocaleString()}</td>
         <td>${L.bank.toLocaleString()}</td>
         <td class="muted">${L.note||''}</td>
       </tr>`
    )).join('');
  }

  /* ==== INIT ==== */
  function init(){
    renderMoneyDigits(bank);
    drawAll();
  }
  init();
})();
</script>
</body>
</html>
