<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini Slot – 3-Reel</title>
<style>
  :root{
    --bg:#000;
    --panel:#111;
    --accent:#e00;
    --gold1:#f7e07a; --gold2:#ffd56a; --gold3:#e7b74a; --gold4:#b88901; 
    --reel-w: 120px; --reel-h: 150px; --reel-gap: 16px;
    --symbol-size: 64px;
    --motion-blur: 0px; /* JS에서 가속 중 0.6~1.2px 정도로 올립니다 */
  }
  html,body{height:100%;}
  body{
    margin:0; background:var(--bg); color:#fff; font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Apple Color Emoji,Noto Color Emoji,AppleGothic,sans-serif;
    display:grid; place-items:center; overflow:hidden;
  }

  /* 무대 */
  .stage{ position:relative; width:min(95vw,800px); padding:24px 24px 34px; background:linear-gradient(180deg,#0c0c0c,#050505);
    border:1px solid #222; border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.6), inset 0 0 40px rgba(255,255,255,.03);
  }

  /* 금액 표시(금 재질) */
  .bank{
    display:flex; align-items:center; justify-content:center;
    font-weight:900; font-size: clamp(28px, 5vw, 48px); letter-spacing:1px; margin-bottom:16px;
    position:relative; user-select:none;
  }
  .bank .gold{
    background: linear-gradient(180deg,var(--gold1),var(--gold2) 35%,var(--gold3) 65%,var(--gold4));
    -webkit-background-clip:text; background-clip:text; color:transparent;
    filter: drop-shadow(0 1px 0 #633) drop-shadow(0 2px 4px rgba(0,0,0,.7));
    text-shadow:
      0 -1px 0 rgba(255,255,255,.25),
      0 1px 0 rgba(0,0,0,.5),
      0 4px 12px rgba(0,0,0,.6);
    transition: filter .15s;
  }
  .bank.counting .gold{
    filter: drop-shadow(0 1px 0 #633) drop-shadow(0 6px 18px rgba(255,215,0,.28)) blur(.4px);
  }
  .label{font-size:.55em; opacity:.75; margin-right:.6em}

  /* 슬롯 박스 */
  .slot-wrap{
    background:linear-gradient(180deg,#1a1a1a,#101010); border:1px solid #2a2a2a; border-radius:14px;
    padding:20px; display:flex; align-items:center; gap:20px; position:relative;
    box-shadow: inset 0 10px 30px rgba(0,0,0,.6), 0 10px 30px rgba(0,0,0,.4);
  }
  .reels{ display:flex; gap:var(--reel-gap); }
  .reel{
    width:var(--reel-w); height:var(--reel-h); overflow:hidden; border-radius:10px;
    background: radial-gradient(100% 100% at 50% 30%, #191919 0%, #0c0c0c 80%);
    border:1px solid #2b2b2b; position:relative;
    box-shadow: inset 0 0 0 2px rgba(255,255,255,.03), inset 0 10px 30px rgba(0,0,0,.7);
  }
  .strip{
    position:absolute; left:0; top:0; width:100%;
    will-change: transform, filter; transform: translate3d(0,0,0);
    filter: url(#mb-y) blur(var(--motion-blur));
  }
  .cell{
    display:grid; place-items:center; height:var(--reel-h);
    font-size:var(--symbol-size); line-height:1;
    text-shadow: 0 2px 8px rgba(0,0,0,.45);
    user-select:none;
  }

  /* 손잡이 */
  .lever{
    position:relative; width:80px; height:220px; margin-left:auto; cursor:pointer; touch-action:manipulation;
    display:grid; place-items:center;
  }
  .lever .shaft{
    width:14px; height:140px; background:linear-gradient(90deg,#444,#999,#444); border-radius:8px;
    box-shadow: inset 0 0 8px rgba(0,0,0,.6);
    transform-origin: center top; transition: transform .15s ease;
  }
  .lever .knob{
    position:absolute; top:0; width:54px; height:54px; border-radius:50%;
    background: radial-gradient(60% 60% at 35% 30%, #ff4d4d, #9f0a0a);
    box-shadow: inset 0 0 14px rgba(255,255,255,.3), 0 10px 20px rgba(0,0,0,.6);
    transition: transform .15s ease;
  }
  .lever.pull .shaft{ transform: translateY(8px) rotate(6deg); }
  .lever.pull .knob{ transform: translateY(110px); }

  /* 잭팟 연출 */
  .jackpot-banner{
    position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; opacity:0; visibility:hidden;
    transition: opacity .25s;
  }
  .jackpot-banner.show{ opacity:1; visibility:visible; }
  .jackpot-text{
    font-size: clamp(48px, 10vw, 120px); font-weight:1000; color:#ff1a1a; letter-spacing:.02em;
    text-shadow: 0 8px 30px rgba(255,0,0,.55), 0 2px 0 #300;
    animation: thump .9s cubic-bezier(.2,1.2,.2,1) 2;
  }
  @keyframes thump{ 0%{ transform:scale(.8)} 50%{ transform:scale(1.12)} 100%{ transform:scale(1)} }

  .rainbow{
    position:absolute; inset:-20vmax; z-index:-1; opacity:0; filter: blur(10px) saturate(1.2);
    background:
      conic-gradient(from 0deg, red, orange, yellow, green, cyan, blue, violet, red);
    mask: radial-gradient(closest-side, rgba(255,255,255,.95), transparent 70%);
    transform: scale(.8) rotate(0deg);
  }
  .rainbow.show{
    animation: spin 1.6s linear infinite, pulse 1.6s ease-in-out infinite alternate;
    opacity:.9;
  }
  @keyframes spin{ to{ transform: scale(1.05) rotate(360deg) } }
  @keyframes pulse{ from{ opacity:.6 } to{ opacity:.93 } }

  /* 하단 메시지 */
  .note{ margin-top:12px; text-align:center; opacity:.65; font-size:.95rem }

  /* 내장 SVG 필터 (세로 방향 모션블러) */
  svg.filters{ position:absolute; width:0; height:0; pointer-events:none; }

  /* 반응형 */
  @media (max-width:560px){
    :root{ --reel-w: 96px; --reel-h: 120px; --symbol-size: 54px; }
    .lever{ display:none; } /* 화면 작은 경우 손잡이 대신 슬롯 박스를 탭해도 작동하도록 JS 처리 */
  }
</style>
</head>
<body>

<div class="stage" id="app">
  <div class="bank" id="bank"><span class="label">보유 금액</span><span class="gold" id="money">0</span></div>

  <div class="slot-wrap" id="slotBox" title="손잡이를 당기거나 슬롯 박스를 탭하세요">
    <div class="reels" id="reels"></div>
    <div class="lever" id="lever" aria-label="손잡이">
      <div class="shaft"></div>
      <div class="knob"></div>
    </div>

    <div class="jackpot-banner" id="jackpot">
      <div class="rainbow" id="rainbow"></div>
      <div class="jackpot-text">잭팟!</div>
    </div>
  </div>

  <div class="note" id="note">손잡이를 당기면 시작하고, 다시 당기면 서서히 멈춥니다.</div>
</div>

<!-- SVG Filter defs -->
<svg class="filters" xmlns="http://www.w3.org/2000/svg">
  <filter id="mb-y">
    <!-- Y축만 살짝 퍼뜨려 방향성 블러 -->
    <feGaussianBlur stdDeviation="0 1.2" edgeMode="duplicate"/>
  </filter>
</svg>

<script>
(() => {
  // ====== CONFIG ======
  const CONFIG = {
    REELS: 3,
    SYMBOLS: ["🍒","🍋","⭐","7️⃣","💎","🔔","🍀","🍇"],
    CELL_H: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--reel-h')) || 150,
    JACKPOT_ODDS: 0.001, // 0.1%
    SPIN_COST: 100,       // 1회 시도 비용
    JACKPOT_PAYOUT: 100000,
    DECELERATION: 0.0009, // 감속 계수(크면 빨리 선다)
    MAX_SPEED: 2.4,       // px/ms
    MIN_SPIN_TIME: 800,   // 최소 회전 유지(ms)
    STOP_STAGGER: 450     // 각 릴의 정지 시작 간격(ms)
  };

  // ====== STATE ======
  const el = {
    reels: document.getElementById('reels'),
    money: document.getElementById('money'),
    bank: document.getElementById('bank'),
    lever: document.getElementById('lever'),
    box: document.getElementById('slotBox'),
    jp: document.getElementById('jackpot'),
    rb: document.getElementById('rainbow'),
    note: document.getElementById('note'),
  };
  let money = 10000;
  let state = 'idle'; // idle | spinning | stopping
  let startTime = 0;
  let rAF = null;

  const reels = []; // {strip, y, speed, target, stoppingAt}
  const rowsPerReel = 2 * CONFIG.SYMBOLS.length; // 무한루프 느낌 위해 2세트
  const cellH = CONFIG.CELL_H;

  // 숫자 촤르륵 애니메이션
  function animateMoney(from, to, duration=600){
    if (from === to) return;
    el.bank.classList.add('counting');
    const t0 = performance.now();
    const ease = t => 1 - Math.pow(1 - t, 3); // easeOutCubic
    function tick(now){
      const p = Math.min(1, (now - t0) / duration);
      const v = Math.round(from + (to - from) * ease(p));
      el.money.textContent = v.toLocaleString();
      if (p < 1) requestAnimationFrame(tick);
      else el.bank.classList.remove('counting');
    }
    requestAnimationFrame(tick);
  }
  function setMoney(newVal){
    const prev = money; money = newVal;
    animateMoney(prev, money);
  }

  // DOM 구성
  function build(){
    // 릴 DOM
    for(let i=0;i<CONFIG.REELS;i++){
      const reel = document.createElement('div');
      reel.className = 'reel';
      const strip = document.createElement('div');
      strip.className = 'strip';
      // 셀 채우기 (2세트)
      const list = [...CONFIG.SYMBOLS, ...CONFIG.SYMBOLS];
      list.forEach(sym=>{
        const c = document.createElement('div');
        c.className = 'cell';
        c.textContent = sym;
        strip.appendChild(c);
      });
      reel.appendChild(strip);
      el.reels.appendChild(reel);
      reels.push({ strip, y: 0, speed: 0, target: null, stoppingAt: null, startedAt: 0, stopped:true });
    }
    el.money.textContent = money.toLocaleString();
  }

  // 레버 시각 효과
  function leverPullOnce(){
    el.lever.classList.add('pull');
    setTimeout(()=> el.lever.classList.remove('pull'), 200);
  }

  // 회전 시작
  function startSpin(){
    if (state !== 'idle') return;
    if (money < CONFIG.SPIN_COST){
      el.note.textContent = '잔액이 부족합니다.';
      leverPullOnce(); return;
    }
    leverPullOnce();
    setMoney(money - CONFIG.SPIN_COST);
    startTime = performance.now();
    state = 'spinning';
    el.note.textContent = '회전 중… 다시 당기면 서서히 멈춥니다.';
    document.documentElement.style.setProperty('--motion-blur', '1px');

    reels.forEach((r, i)=>{
      r.speed = CONFIG.MAX_SPEED * (0.95 + Math.random()*0.1); // 약간 차이
      r.startedAt = startTime;
      r.stoppingAt = null;
      r.stopped = false;
    });

    if (!rAF) rAF = requestAnimationFrame(loop);
  }

  // 감속 시작 (사용자가 다시 당김)
  function beginStop(){
    if (state !== 'spinning') return;
    leverPullOnce();
    state = 'stopping';
    el.note.textContent = '서서히 멈추는 중…';
    const t0 = performance.now();
    reels.forEach((r, i)=>{
      r.stoppingAt = t0 + CONFIG.STOP_STAGGER * i;
    });
  }

  // 애니메이션 루프
  function loop(now){
    let allStopped = true;
    for (const r of reels){
      // 이동
      r.y += r.speed * (r.last ? (now - r.last) : 16);
      r.last = now;
      // 무한 스크롤
      const totalH = rowsPerReel * cellH;
      if (r.y >= totalH) r.y -= totalH;
      r.strip.style.transform = `translate3d(0, ${- (r.y % totalH)}px, 0)`;

      // 감속/정지 로직
      if (state === 'stopping' && now >= (r.stoppingAt ?? Infinity)){
        // 서서히 감속
        if (r.speed > 0.02){
          r.speed = Math.max(0.02, r.speed * (1 - CONFIG.DECELERATION * (now - (r._decT || now))));
          r._decT = now;
          allStopped = false;
        }else{
          // 셀 경계에 스냅
          const idxFloat = (r.y / cellH);
          const idx = Math.round(idxFloat);
          r.y = idx * cellH;
          r.strip.style.transform = `translate3d(0, ${- (r.y % totalH)}px, 0)`;
          r.speed = 0; r.stopped = true;
        }
      }else if (state === 'spinning'){
        // 최소 회전 시간 전에는 계속 회전
        if (now - startTime < CONFIG.MIN_SPIN_TIME) allStopped = false;
      }

      if (state === 'spinning' && (now - startTime) >= CONFIG.MIN_SPIN_TIME){
        // 여전히 회전 유지 중
        allStopped = false;
      }
      if (!r.stopped) allStopped = false;
    }

    // 모션블러 강도 동적 조절
    const avgSpd = reels.reduce((s,r)=>s+r.speed,0)/reels.length;
    document.documentElement.style.setProperty('--motion-blur', avgSpd>0.4 ? '1.0px' : avgSpd>0.1 ? '0.6px' : '0px');

    if (!allStopped){
      rAF = requestAnimationFrame(loop);
      return;
    }

    // 모두 정지됨
    rAF = null;
    state = 'idle';
    el.note.textContent = '완료! 다시 당기면 재시작됩니다.';

    // 잭팟 판정 (0.1%)
    if (Math.random() < CONFIG.JACKPOT_ODDS){
      triggerJackpot();
    }
  }

  // 잭팟 연출
  function triggerJackpot(){
    // 포상 지급
    setMoney(money + CONFIG.JACKPOT_PAYOUT);

    // 비주얼
    el.jp.classList.add('show');
    el.rb.classList.add('show');

    // 1.8초 후 종료
    setTimeout(()=>{
      el.jp.classList.remove('show');
      el.rb.classList.remove('show');
    }, 1800);
  }

  // 입력 바인딩
  function bind(){
    const handleToggle = () => {
      if (state === 'idle') startSpin();
      else if (state === 'spinning') beginStop();
      else if (state === 'stopping') { /* 무시 */ }
    };
    el.lever.addEventListener('click', handleToggle);
    // 모바일/작은 화면: 슬롯 박스 탭으로도 작동
    el.box.addEventListener('click', (e)=>{
      if (e.target.closest('.lever')) return;
      // 작은 화면에서는 박스 탭으로도
      if (window.matchMedia('(max-width:560px)').matches) handleToggle();
    });
    // 스페이스바
    window.addEventListener('keydown', (e)=>{
      if (e.code === 'Space'){ e.preventDefault(); handleToggle(); }
    });
  }

  // 초기화: 심볼 높이 재계산(모바일 대응)
  function recalibrate(){
    const h = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--reel-h')) || 150;
    CONFIG.CELL_H = h;
  }

  // 심볼 배치 초기 무작위 오프셋
  function randomizeStops(){
    reels.forEach(r=>{
      r.y = Math.floor(Math.random()*rowsPerReel) * cellH;
      r.strip.style.transform = `translate3d(0, ${- (r.y % (rowsPerReel*cellH))}px, 0)`;
    });
  }

  // 부드러운 시작
  build(); bind(); recalibrate(); randomizeStops();
})();
</script>
</body>
</html>
