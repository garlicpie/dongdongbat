<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Slot</title>
<style>
  :root{
    --bg:#000;
    --gold1:#fff89a; --gold2:#ffe14b; --gold3:#ffd100; --gold4:#c99600; /* ë” ë…¸ë€ ê¸ˆìƒ‰ */
    --reelW: 120px; --reelH: 140px; --gap: 16px; /* ìš”ì²­: í¬ê¸° ì¡°ê¸ˆ ì¶•ì†Œ */
    --border:#2a2a2a;
  }
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:#fff;overflow:hidden;
    font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple Color Emoji,Noto Color Emoji,sans-serif;
    display:grid;place-items:center;
  }

  .wrap{position:relative;width:min(96vw,760px);height:min(86vh,560px)}

  /* ì¤‘ì•™ ìŠ¬ë¡¯ ìº”ë²„ìŠ¤ */
  #slot{
    position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    image-rendering:auto;
  }

  /* ê° ë¦´ ë°•ìŠ¤ì˜ ì™¸ê³½ì€ ìº”ë²„ìŠ¤ì—ì„œ ê·¸ë¦¼. ì´ê±´ ëˆ/FX/ì½˜ì†” ë“±ì˜ UIë§Œ */
  .money{
    position:absolute;top:20px;left:50%;transform:translateX(-50%);
    font-weight:1000;font-size:clamp(28px,6vw,52px);
    letter-spacing:.5px;user-select:none;white-space:nowrap;
    background:linear-gradient(180deg,var(--gold1),var(--gold2) 40%,var(--gold3) 70%,var(--gold4));
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 2px 0 rgba(0,0,0,.55), 0 10px 26px rgba(255,224,0,.28);
  }

  /* ëˆ 'ì´¤ë¼ë½' ì „í™˜ */
  .money-stack{position:absolute;top:20px;left:50%;transform:translateX(-50%);height:1em;overflow:visible}
  .money-old,.money-new{font-weight:1000;font-size:clamp(28px,6vw,52px);letter-spacing:.5px;white-space:nowrap;
    background:linear-gradient(180deg,var(--gold1),var(--gold2) 40%,var(--gold3) 70%,var(--gold4));
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 2px 0 rgba(0,0,0,.55), 0 10px 26px rgba(255,224,0,.28);
    position:absolute;left:50%;transform:translate(-50%,0);
  }
  .fall-out{animation:fallOut .35s ease forwards}
  .fall-in{animation:fallIn .35s ease forwards}
  @keyframes fallOut{ from{transform:translate(-50%,0);opacity:1} to{transform:translate(-50%,26px);opacity:.0}}
  @keyframes fallIn { from{transform:translate(-50%,-26px);opacity:.0} to{transform:translate(-50%,0);opacity:1}}

  /* ì­íŒŸ FX (ì˜ì–´ë§Œ) */
  .fx{ position:absolute;inset:0;pointer-events:none; }
  .jackpot{
    position:absolute;inset:0;display:grid;place-items:center;opacity:0;visibility:hidden;transition:opacity .25s;
  }
  .jackpot.show{opacity:1;visibility:visible}
  .jackpot .txt{
    font-size:clamp(52px,12vw,140px);font-weight:1000;color:#ff1a1a;letter-spacing:.02em;
    text-shadow:0 10px 36px rgba(255,0,0,.55),0 2px 0 #300;animation:thump .9s cubic-bezier(.2,1.2,.2,1) 2;
  }
  @keyframes thump{0%{transform:scale(.82)}50%{transform:scale(1.12)}100%{transform:scale(1)}}
  .rainbow{
    position:absolute;inset:-25vmax;z-index:-1;opacity:0;filter:blur(10px) saturate(1.2);
    background:conic-gradient(from 0deg,red,orange,yellow,green,cyan,blue,violet,red);
    mask:radial-gradient(closest-side,rgba(255,255,255,.95),transparent 70%);
    transform:scale(.85) rotate(0deg);
  }
  .rainbow.show{ animation:spin 1.6s linear infinite, pulse 1.6s ease-in-out infinite alternate; opacity:.9 }
  @keyframes spin{to{transform:scale(1.05) rotate(360deg)}}
  @keyframes pulse{from{opacity:.6}to{opacity:.93}}

  /* ì½˜ì†” ì…ë ¥ì°½ */
  .console{
    position:absolute;left:50%;bottom:22px;transform:translateX(-50%);
    width:min(680px,92vw);display:none;
  }
  .console.show{display:block}
  .console input{
    width:100%;padding:12px 14px;border-radius:10px;border:1px solid #333;outline:none;color:#fff;background:#0d0d0d;
    box-shadow:0 6px 20px rgba(0,0,0,.5), inset 0 0 0 2px rgba(255,255,255,.03);
    font-size:16px;letter-spacing:.3px;
  }

  /* DEV íŒ¨ë„ (ì˜ë¬¸) */
  .dev{
    position:absolute;right:16px;top:16px;width:min(520px,92vw);max-height:70vh;overflow:auto;
    background:#0b0b0b;border:1px solid #2a2a2a;border-radius:12px;padding:14px 14px;color:#ddd;
    font: 12.5px/1.45 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    display:none;
  }
  .dev.show{display:block}
  .dev h3{margin:.3em 0 .5em;font-size:13.5px;color:#ffe14b}
  .dev table{width:100%;border-collapse:collapse;margin:6px 0 10px}
  .dev th,.dev td{border-bottom:1px solid #222;padding:6px 8px;text-align:left}
  .dev .muted{opacity:.7}
</style>
</head>
<body>
<div class="wrap" id="app">
  <canvas id="slot" width="420" height="160" aria-label="slot"></canvas>

  <!-- ëˆ(ìˆ«ìë§Œ) -->
  <div class="money" id="money" aria-live="polite">10,000</div>
  <div class="money-stack" id="moneyStack" aria-hidden="true"></div>

  <!-- FX -->
  <div class="fx">
    <div class="rainbow" id="rainbow"></div>
    <div class="jackpot" id="jackpot"><div class="txt">JACKPOT!</div></div>
  </div>

  <!-- ì½˜ì†” -->
  <div class="console" id="console"><input id="cmd" type="text" spellcheck="false" autocomplete="off" placeholder="/777, /dev, /devoff"/></div>

  <!-- DEV íŒ¨ë„ -->
  <div class="dev" id="devPanel">
    <h3>DEV</h3>
    <div id="rules"></div>
    <div id="rtp" style="margin:8px 0 4px"></div>
    <div class="muted">Logs (latest 30)</div>
    <table id="logs"><thead><tr><th>time</th><th>sym</th><th>bet</th><th>payout</th><th>delta</th><th>bank</th><th>note</th></tr></thead><tbody></tbody></table>
  </div>
</div>

<script>
(()=> {
  // ========= CONFIG (ì˜ë¬¸ë§Œ) =========
  const CFG = {
    reels: 3,
    reelW: 120, reelH: 140, gap: 16,             // ìš”ì²­: ë¦´ ë°•ìŠ¤ ìœ ì§€ + ì‚¬ì´ì¦ˆ ì¶•ì†Œ
    cost: 100,                                    // bet per spin (ìŒìˆ˜ í—ˆìš©: ë¶€ì¡±í•´ë„ ì°¨ê°)
    // ê°€ì¤‘ì¹˜(í™•ë¥ ) â€” ê°’ì´ í´ìˆ˜ë¡ ìì£¼ ë‚˜ì˜µë‹ˆë‹¤
    weights: { "ğŸ’":6, "ğŸ‹":6, "â­":3, "7":1, "ğŸ’":2, "ğŸ””":4, "ğŸ€":5, "ğŸ‡":6 },
    // ë°°ë‹¹(ë°°ìˆ˜). 3ê°œ ì¼ì¹˜/2ê°œ ì¼ì¹˜. (bet * multiplier)
    pay3:    { "7":1000, "ğŸ’":200, "â­":80, "ğŸ””":30, "ğŸ€":20, "ğŸ’":10, "ğŸ‹":8, "ğŸ‡":6 },
    pay2:    { "7":25,   "ğŸ’":6,   "â­":3,  "ğŸ””":2,  "ğŸ€":2,  "ğŸ’":2,  "ğŸ‹":2, "ğŸ‡":2 },
    // ì‹œê°/ë™ì‘
    minSpin: 650,            // ìµœì†Œ íšŒì „ ìœ ì§€(ms)
    stagger: 420,            // ë¦´ ì •ì§€ ì‹œì‘ ê°„ê²©(ms)
    spinSpeed: 16.0,         // px/frame(ì•½ 60fps ê¸°ì¤€)
    cellPad: 0.06            // ì…€ ë‚´ ìƒí•˜ íŒ¨ë”© ë¹„ìœ¨ (ì´ëª¨ì§€ ì•ˆì • í‘œì‹œ)
  };

  // ========= STATE =========
  const el = {
    cvs: document.getElementById('slot'),
    money: document.getElementById('money'),
    moneyStack: document.getElementById('moneyStack'),
    jackpot: document.getElementById('jackpot'),
    rainbow: document.getElementById('rainbow'),
    console: document.getElementById('console'),
    cmd: document.getElementById('cmd'),
    dev: document.getElementById('devPanel'),
    rules: document.getElementById('rules'),
    rtp: document.getElementById('rtp'),
    logs: document.querySelector('#logs tbody')
  };
  const ctx = el.cvs.getContext('2d');

  // DPR ìŠ¤ì¼€ì¼
  function fitCanvas(){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
    const W = CFG.reelW*CFG.reels + CFG.gap*(CFG.reels-1);
    const H = CFG.reelH;
    el.cvs.style.width = W + 'px'; el.cvs.style.height = H + 'px';
    el.cvs.width = Math.floor(W * dpr); el.cvs.height = Math.floor(H * dpr);
    return dpr;
  }
  let DPR = fitCanvas();
  window.addEventListener('resize', ()=>{ DPR = fitCanvas(); drawStatic(); });

  // ì‹¬ë³¼/ìŠ¤í”„ë¼ì´íŠ¸ì‹œíŠ¸ (ì„¸ë¡œ)
  const SYMBOLS = ["ğŸ’","ğŸ‹","â­","7","ğŸ’","ğŸ””","ğŸ€","ğŸ‡"];
  const IDX = Object.fromEntries(SYMBOLS.map((s,i)=>[s,i]));
  const N = SYMBOLS.length;

  const cellH = CFG.reelH;              // í•œ ì¹¸ ë†’ì´ = ë³´ì´ëŠ” ì°½ ë†’ì´ (ì¤‘ì•™ 1ì¹¸ë§Œ ë³´ì´ê²Œ)
  const cellW = CFG.reelW;

  // ì˜¤í”„ìŠ¤í¬ë¦° ì„¸ë¡œ ìŠ¤í”„ë¼ì´íŠ¸(ì •ë°©í˜•ì— ë§ì¶° í¬ê²Œ ê·¸ë¦° ë’¤ ì¶•ì†Œ)
  function makeSheet(){
    const px = Math.max(220, Math.floor(cellH*1.8)); // ê³ í•´ìƒë„ í›„ ì¶•ì†Œ
    const cnv = document.createElement('canvas'); cnv.width = cellW; cnv.height = px * N;
    const c = cnv.getContext('2d');
    c.textAlign = 'center'; c.textBaseline = 'middle';

    for (let i=0;i<N;i++){
      const y = i*px + px/2;
      if (SYMBOLS[i]==="7"){
        c.font = `900 ${Math.floor(px*0.68)}px Arial Black, Impact, system-ui, sans-serif`;
        c.fillStyle = '#fff';
        c.lineWidth = Math.max(2, px*0.02); c.strokeStyle = 'rgba(0,0,0,.45)';
        c.strokeText('7', cellW/2, y);
        c.fillText('7', cellW/2, y);
      }else{
        c.font = `${Math.floor(px*0.82)}px Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji`;
        c.fillText(SYMBOLS[i], cellW/2, y);
      }
    }
    return {sheet:cnv, px};
  }
  const SPR = makeSheet();

  // ë¦´ ìƒíƒœ
  const reels = Array.from({length:CFG.reels}, (_,i)=>({
    y: Math.random()*N*cellH,   // ìŠ¤í¬ë¡¤ ìœ„ì¹˜(px)
    v: 0,                       // ì†ë„(px/frame)
    targetIndex: null,          // ë©ˆì¶œ ì¸ë±ìŠ¤
    stopAt: null,               // ê°ì† ì‹œì‘ ì‹œê°
    stopping:false,
    stopped:true
  }));

  let bank = 10000;            // ìŒìˆ˜ í—ˆìš©
  let state = 'idle';          // idle | spinning | stopping
  let startAt = 0;
  let rAF = 0;
  let planIndices = null;      // ì´ë²ˆ ìŠ¤í•€ì— ë©ˆì¶œ 3ê°œ ì¸ë±ìŠ¤(í™•ì •í˜• RNG, ì¹˜íŠ¸ ë°˜ì˜)
  let devMode = false;

  // ë¡œê·¸
  const logs = []; // {t,sym:[...],bet,payout,delta,bank,note}

  // ëˆ í‘œì‹œ
  function setMoney(v){
    const from = bank;
    bank = v;
    rollMoney(from, v);
  }
  function rollMoney(from,to){
    // ê¸°ì¡´ ìˆ«ìë¥¼ ì•„ë˜ë¡œ, ìƒˆ ìˆ«ìë¥¼ ìœ„ì—ì„œ ì•„ë˜ë¡œ
    const old = document.createElement('div');
    old.className='money-old';
    old.textContent = from.toLocaleString();

    const neu = document.createElement('div');
    neu.className='money-new';
    neu.textContent = to.toLocaleString();

    el.money.style.visibility='hidden';
    el.moneyStack.innerHTML='';
    el.moneyStack.appendChild(old);
    el.moneyStack.appendChild(neu);
    requestAnimationFrame(()=>{
      old.classList.add('fall-out');
      neu.classList.add('fall-in');
      setTimeout(()=>{
        el.money.textContent = to.toLocaleString();
        el.money.style.visibility='visible';
        el.moneyStack.innerHTML='';
      }, 360);
    });
  }

  // ê²°ê³¼ â†’ ë°°ë‹¹ ê³„ì‚°
  function payoutFor(indices){
    const sym = indices.map(i=>SYMBOLS[i]);
    const counts = {};
    sym.forEach(s=>counts[s]=(counts[s]||0)+1);
    let multi = 0;
    // 3ê°œ ì¼ì¹˜ ìš°ì„ 
    for(const s of Object.keys(counts)){
      if(counts[s]===3){ multi = (CFG.pay3[s]||0); break; }
    }
    if(multi===0){
      // 2ê°œ ì¼ì¹˜
      for(const s of Object.keys(counts)){
        if(counts[s]===2){ multi = (CFG.pay2[s]||0); break; }
      }
    }
    return {multiplier: multi, symbols: sym};
  }

  // ì´ë¡  RTP ê³„ì‚°(ë‹¨ì¼ í˜ì´ë¼ì¸, ë…ë¦½ ë¦´, ë™ì¼ ë¶„í¬ ê°€ì •)
  function calcRTP(){
    const weights = SYMBOLS.map(s=>CFG.weights[s]||0);
    const sumW = weights.reduce((a,b)=>a+b,0);
    const p = weights.map(w=>w/sumW);

    // 3 of a kind
    let rtp = 0;
    for(let i=0;i<N;i++){
      const m3 = CFG.pay3[SYMBOLS[i]]||0;
      rtp += m3 * Math.pow(p[i],3);
    }
    // exactly 2 of a kind (3ê°€ì§€ ìë¦¬ ê²½ìš°ì˜ ìˆ˜)
    for(let i=0;i<N;i++){
      const m2 = CFG.pay2[SYMBOLS[i]]||0;
      rtp += m2 * (3 * Math.pow(p[i],2) * (1 - p[i]));
    }
    return rtp; // ë°°ë‹¹ë°°ìˆ˜ ê¸°ëŒ€ê°’ (bet=1 ê¸°ì¤€)
  }

  // RNG: ì´ë²ˆ ìŠ¤í•€ì— ë©ˆì¶œ ì¸ë±ìŠ¤ í™•ì •
  function pickOutcome(forced=null){
    if(forced){ return forced.slice(); }
    // ë¦´ ë…ë¦½, ê°€ì¤‘ì¹˜ì— ë”°ë¼ 1ê°œì”©
    const bag = SYMBOLS.map(s=>({s,w:CFG.weights[s]}));
    const sum = bag.reduce((a,b)=>a+b.w,0);
    const pickOne = ()=>{
      let x = Math.random()*sum;
      for(const it of bag){ if((x-=it.w)<0) return IDX[it.s]; }
      return IDX[bag[bag.length-1].s];
    };
    return [pickOne(), pickOne(), pickOne()];
  }

  // ì­íŒŸ FX
  function showJackpot(){
    el.jackpot.classList.add('show');
    el.rainbow.classList.add('show');
    setTimeout(()=>{
      el.jackpot.classList.remove('show');
      el.rainbow.classList.remove('show');
    }, 1800);
  }

  // ë Œë” ë³´ì¡°: ë¼ìš´ë“œ ë°•ìŠ¤
  function rrect(x,y,w,h,r){
    const k = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+k, y);
    ctx.arcTo(x+w, y, x+w, y+h, k);
    ctx.arcTo(x+w, y+h, x, y+h, k);
    ctx.arcTo(x, y+h, x, y, k);
    ctx.arcTo(x, y, x+w, y, k);
    ctx.closePath();
  }

  // í•œ ë¦´ ê·¸ë¦¬ê¸°
  function drawReel(i){
    const W = el.cvs.width, H = el.cvs.height;
    const rw = Math.floor(CFG.reelW*DPR), rh = Math.floor(CFG.reelH*DPR);
    const gap = Math.floor(CFG.gap*DPR);

    const totalW = rw*CFG.reels + gap*(CFG.reels-1);
    const x0 = Math.floor((W - totalW)/2) + i*(rw+gap);
    const y0 = Math.floor((H - rh)/2);

    // ë°•ìŠ¤(ì™¸ê³½)
    ctx.save();
    rrect(x0, y0, rw, rh, 12*DPR);
    ctx.fillStyle = '#101010';
    ctx.fill();
    ctx.strokeStyle = 'rgba(255,255,255,0.06)';
    ctx.lineWidth = 2*DPR;
    ctx.stroke();
    ctx.clip();

    // ìŠ¤í”„ë¼ì´íŠ¸ ì‹œíŠ¸ì—ì„œ í˜„ì¬ ì˜¤í”„ì…‹ ìœ„ì¹˜ ê·¸ë¦¬ê¸°
    const r = reels[i];
    const totalH = SPR.px*N;            // ì‹œíŠ¸ ë†’ì´
    // í‘œì‹œ ì˜ì—­ ë†’ì´ = rh. ì¤‘ì•™ í•œ ì¹¸ ê½‰ ì°¨ê²Œ
    // y ì˜¤í”„ì…‹: r.y(px) ë§Œí¼ ìœ„ë¡œ ìŠ¤í¬ë¡¤
    // ì‹œíŠ¸ëŠ” ìœ„ì•„ë˜ë¡œ ë°˜ë³µ
    let off = Math.floor(r.y) % (N*cellH);
    if(off<0) off += N*cellH;

    // í™”ë©´ì— ê·¸ë¦´ ì…€ ì¸ë±ìŠ¤ ë²”ìœ„ ê³„ì‚°
    const baseIdx = Math.floor(off / cellH);
    const shift   = Math.floor(off % cellH);

    // ìœ„ìª½ë¶€í„° 3ì¹¸ ì •ë„ ê·¸ë ¤ì„œ ì±„ìš´ë‹¤
    for(let k=-1;k<=2;k++){
      const idx = (baseIdx + k + N) % N;
      const sy = idx * SPR.px; // ì‹œíŠ¸ ìƒë‹¨ y
      const dy = y0 + (k*cellH - shift) * DPR;

      // ì´ëª¨ì§€/7ì´ ì˜ ë³´ì´ë„ë¡ ìƒí•˜ íŒ¨ë”©
      const pad = Math.floor(cellH*CFG.cellPad)*DPR;
      ctx.drawImage(
        SPR.sheet,
        0, sy, cellW, SPR.px,
        x0, Math.floor(dy+pad), rw, Math.floor(rh - pad*2)
      );
    }
    ctx.restore();
  }

  // ì •ì§€ ì‹œ ëª©í‘œ ì¸ë±ìŠ¤ë¡œ ìŠ¤ëƒ…
  function snapToIndex(r, idx){
    // í˜„ì¬ r.yë¡œë¶€í„° ì¤‘ì•™ ì¹¸ì´ idxê°€ ë˜ë„ë¡ ë³´ì •
    // ì¤‘ì•™ ì¹¸ì€ í™”ë©´ ë†’ì´ í•œ ì¹¸ì´ë¯€ë¡œ, ì˜¤í”„ì…‹ì„ idx*cellHë¡œ ì •ë ¬
    const cur = r.y;
    const targetY = Math.round(idx)*cellH;
    // ì•ìœ¼ë¡œ ì§„í–‰ ë°©í–¥(ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤) ê¸°ì¤€, ê°€ê¹Œìš´ ë‹¤ìŒ idx ìœ„ì¹˜ë¡œ ì„¤ì •
    const mod = N*cellH;
    let t = targetY;
    if (t < cur) t += Math.ceil((cur - t)/mod)*mod;
    return t;
  }

  // í•œ í”„ë ˆì„
  function frame(now){
    const dt = 16; // ê³ ì • ìŠ¤í…(60fps ê°€ì •)ë¡œ ë¶€ë“œëŸ¬ìš´ ë“±ì†ê°
    ctx.clearRect(0,0,el.cvs.width,el.cvs.height);

    let allStopped = true;
    for(let i=0;i<reels.length;i++){
      const r = reels[i];

      if(state==='spinning'){
        r.v = CFG.spinSpeed;
        r.stopped = false;
        allStopped = false;
      }else if(state==='stopping' && now >= (r.stopAt ?? Infinity)){
        // ê°ì† + ëª©í‘œë¡œ ìˆ˜ë ´
        r.v = Math.max(1.2, r.v * 0.92);
        const targetY = snapToIndex(r, planIndices[i]) + i*0; // ê° ë¦´ ê°™ì€ ì¸ë±ìŠ¤
        // ë¶€ë“œëŸ½ê²Œ ê·¼ì ‘
        r.y += Math.min(r.v, Math.max(0, targetY - r.y));
        if (Math.abs(targetY - r.y) < 0.8){
          r.y = targetY;
          r.v = 0;
          r.stopped = true;
        }else{
          r.stopped = false; allStopped = false;
        }
      }else if(state==='stopping'){
        r.stopped = false; allStopped = false;
      }

      // ë“±ì† íšŒì „
      if(!r.stopped && state!=='stopping') r.y += r.v;

      drawReel(i);
    }

    if(!allStopped){ rAF = requestAnimationFrame(frame); return; }

    // ëª¨ë‘ ì •ì§€ â†’ íŒì •/ì •ì‚°
    rAF = 0; state = 'idle';
    settleAndLog();
  }

  // ìŠ¤í•€ ì‹œì‘ / ì •ì§€
  function startSpin(){
    if(state!=='idle') return;
    const bet = CFG.cost;
    const before = bank;
    setMoney(bank - bet); // ìŒìˆ˜ í—ˆìš©
    startAt = performance.now();
    state = 'spinning';
    // ì´ë²ˆ ìŠ¤í•€ ê²°ê³¼ í™•ì •
    if (!planIndices) planIndices = pickOutcome();
    // í”„ë ˆì„ ë£¨í”„
    if(!rAF) rAF = requestAnimationFrame(frame);
  }
  function beginStop(){
    if(state!=='spinning') return;
    state = 'stopping';
    const t0 = performance.now();
    reels.forEach((r,i)=>{ r.stopAt = t0 + CFG.stagger*i; });
  }

  // ê²°ê³¼ ì •ì‚°/ë¡œê·¸
  function settleAndLog(){
    const idx = reels.map(r=>{
      // ì¤‘ì•™ ì¹¸ ì¸ë±ìŠ¤
      let k = Math.round((r.y / cellH)) % N;
      if(k<0) k += N; return k;
    });
    const bet = CFG.cost;
    const pay = payoutFor(idx);
    const payout = bet * (pay.multiplier||0);
    const delta = -bet + payout;
    const before = bank;
    setMoney(bank + payout); // ì´ë¯¸ betëŠ” ì‹œì‘ ë•Œ ì°¨ê° ì™„ë£Œ
    const after = bank;

    // ì­íŒŸ FX (7Ã—3)
    const isJackpot = pay.multiplier>=1000 && pay.symbols.every(s=>s==='7');
    if (isJackpot) showJackpot();

    logs.unshift({
      t: new Date().toLocaleTimeString(),
      sym: pay.symbols.join(' '),
      bet, payout, delta, bank: after,
      note: isJackpot?'JACKPOT':''})
    if (logs.length>30) logs.pop();

    updateDev();
    planIndices = null; // ì†Œì§„
  }

  // ì´ˆê¸° ì •ì  ê·¸ë¦¬ê¸°
  function drawStatic(){
    ctx.clearRect(0,0,el.cvs.width,el.cvs.height);
    for(let i=0;i<reels.length;i++) drawReel(i);
  }

  // ========= INPUT =========
  // íƒ­/í´ë¦­ ë˜ëŠ” Spaceë¡œ í† ê¸€
  el.cvs.addEventListener('click', ()=>{ if(state==='idle') startSpin(); else if(state==='spinning') beginStop(); });
  window.addEventListener('keydown', (e)=>{
    if(e.code==='Space'){ e.preventDefault(); if(state==='idle') startSpin(); else if(state==='spinning') beginStop(); return; }
    if(e.key==='/'){ e.preventDefault(); openConsole(); return; }
  });

  // ========= ì½˜ì†” =========
  function openConsole(){
    el.console.classList.add('show');
    el.cmd.value = '/';
    el.cmd.focus();
    el.cmd.setSelectionRange(el.cmd.value.length, el.cmd.value.length);
  }
  function closeConsole(){ el.console.classList.remove('show'); el.cmd.blur(); }

  el.cmd.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){ e.preventDefault(); closeConsole(); return; }
    if(e.key==='Enter'){
      e.preventDefault();
      const str = el.cmd.value.trim();
      runCommand(str);
      el.cmd.value='';
      closeConsole();
    }
  });

  function runCommand(cmd){
    if(cmd==='/dev'){ devMode = true; updateDev(true); return; }
    if(cmd==='/devoff'){ devMode = false; updateDev(false); return; }
    if(cmd==='/777'){
      // ë‹¤ìŒ ìŠ¤í•€ ì­íŒŸ ê°•ì œ
      planIndices = [IDX['7'], IDX['7'], IDX['7']];
      if(state==='idle'){
        startSpin();
        setTimeout(()=>{ if(state==='spinning') beginStop(); }, Math.max(220, CFG.minSpin));
      }else if(state==='spinning'){
        // ì´ë¯¸ íšŒì „ ì¤‘ì´ë©´ ì •ì§€ ëª…ë ¹
        beginStop();
      }
      return;
    }
    // ê¸°íƒ€ í™•ì¥ìš© (ì˜ˆ: /money 50000) â€” ìš”êµ¬ì‚¬í•­ì—” ì—†ìŒ
  }

  // ========= DEV =========
  function updateDev(showNow){
    if(showNow!==undefined){
      el.dev.classList.toggle('show', !!showNow);
    }else{
      el.dev.classList.toggle('show', devMode);
    }
    if(!devMode) return;

    // ê·œì¹™/ë°°ë‹¹/í™•ë¥ 
    const w = SYMBOLS.map(s=>({s, w: CFG.weights[s], p:0}));
    const sumW = w.reduce((a,b)=>a+b.w,0);
    w.forEach(o=>o.p = (o.w/sumW));
    const pay3 = SYMBOLS.map(s=>`${s}Ã—3: x${CFG.pay3[s]||0}`).join('  |  ');
    const pay2 = SYMBOLS.map(s=>`${s}Ã—2: x${CFG.pay2[s]||0}`).join('  |  ');
    el.rules.innerHTML = `
      <div><b>weights</b> â†’ ${w.map(o=>`${o.s}:${o.w} (p=${o.p.toFixed(3)})`).join('  Â·  ')}</div>
      <div style="margin-top:6px"><b>payout 3</b> â†’ ${pay3}</div>
      <div><b>payout 2</b> â†’ ${pay2}</div>
      <div class="muted" style="margin-top:4px">line: middle only, reels independent, fixed outcome per spin</div>
    `;
    const rtp = calcRTP();
    el.rtp.textContent = `RTPâ‰ˆ ${(rtp*100).toFixed(2)}%  (bet=1 baseline)`;

    // ë¡œê·¸
    el.logs.innerHTML = logs.map(L=>(
      `<tr>
        <td class="muted">${L.t}</td>
        <td>${L.sym}</td>
        <td>${L.bet.toLocaleString()}</td>
        <td>${L.payout.toLocaleString()}</td>
        <td style="color:${L.delta>=0?'#6ef06e':'#ff6b6b'}">${(L.delta>=0?'+':'')}${L.delta.toLocaleString()}</td>
        <td>${L.bank.toLocaleString()}</td>
        <td class="muted">${L.note||''}</td>
      </tr>`
    )).join('');
  }

  // ========= INIT =========
  (function init(){
    // ì´ˆê¸° DPR ë°˜ì˜
    drawStatic();
    el.money.textContent = bank.toLocaleString();

    // ìµœì†Œ íšŒì „ ìœ ì§€ íƒ€ì´ë¨¸
    setInterval(()=>{
      if(state==='spinning' && (performance.now()-startAt)>=CFG.minSpin && !reels.some(r=>r.stopping)){
        // ìœ ì €ê°€ ì •ì§€ë¥¼ ì•ˆ ëˆ„ë¥´ë©´ ìë™ ê°ì† ì‹œì‘
        beginStop();
      }
    }, 80);
  })();
})();
</script>
</body>
</html>
