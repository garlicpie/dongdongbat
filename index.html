<!DOCTYPE html><html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>ã€ë™ì–¸ë±ƒã€ v2</title>
<style>
  :root{
    --bg:#0a0c13; --panel:#101421; --panel2:#0c111c; --line:#1a2234;
    --text:#eaf0ff; --muted:#9aa6bf;
    --odd:#d93a6b; --even:#1fb98a; --rand:#2b8cff; --ghost:#0f1525;
    --gold:#f6d36b; --good:#19e3a1; --bad:#ff5a5a;
    --btn-justify:flex-start;
    --glass:bg(15,18,28,0.55);
  }
  .theme-light{
    --bg:#f6f7fb; --panel:#ffffff; --panel2:#f0f3fa; --line:#e3e7f2;
    --text:#111827; --muted:#475569; --ghost:#eaeef7;
  }
  @supports(backdrop-filter: blur(10px)){
    :root{ --glass: rgba(16,18,28,0.5); }
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%;}
  body{
    margin:0; color:var(--text);
    font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
    background: radial-gradient(1200px 600px at 10% 10%,#10152a 0%,#0b0f19 45%,#070a11 100%);
    -webkit-text-size-adjust:100%;
    touch-action: manipulation;
    overflow-x:hidden;
    position:relative;
  }
  body::before{
    content:""; position:fixed; inset:0; z-index:0; pointer-events:none;
    background:
      radial-gradient(1200px 700px at 0% 0%, rgba(40,80,180,.35), transparent 60%),
      radial-gradient(1000px 700px at 100% 100%, rgba(10,200,150,.25), transparent 60%),
      radial-gradient(600px 450px at 50% 20%, rgba(240,200,80,.22), transparent 60%);
    filter: saturate(1.1) contrast(1.05);
  }
  .theme-light{ background: linear-gradient(180deg,#f8fafc,#eef2ff); }
  #fxCanvas{ position:fixed; inset:0; z-index:0; display:block; pointer-events:none; mix-blend-mode:screen }/* ìƒë‹¨ ì”ì•¡ ë°” */ .balance-bar{ position: sticky; top: 0; z-index: 40; margin: 8px; padding: 10px 12px; font-weight:900; background: rgba(16,18,28,.55); border:1px solid rgba(255,255,255,.08); border-radius:14px; display:flex; gap:12px; align-items:center; backdrop-filter: blur(14px) saturate(1.2); } .balance-pill{ padding:6px 10px; border-radius:999px; background:rgba(12,17,29,.5); border:1px solid #18233a } .theme-light .balance-pill{ background:rgba(255,255,255,.6); border-color:#e3e7f2 }

/* ë ˆì´ì•„ì›ƒ */ .container{ max-width: 1080px; margin: 8px auto 80px; display:grid; gap: 14px; padding: 0 8px; position:relative; z-index:10 } .card{ background:rgba(16,20,33,.58); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:16px; backdrop-filter: blur(14px) saturate(1.15); box-shadow: 0 8px 24px rgba(0,0,0,.28); } .title{display:flex; align-items:center; justify-content:space-between} h1,h2{margin:0; font-size: clamp(18px, 2.2vw, 24px)} .sub{color:var(--muted); font-size:12px}

.jackpot{display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px; font-weight:800} .jackpot .num{color:var(--gold)}

/* ë²„íŠ¼ */ .btn-row{display:flex; flex-wrap:wrap; gap:8px; justify-content: var(--btn-justify)} button{ border:none; border-radius:10px; padding:12px 14px; font-weight:800; color:#fff; cursor:pointer; transition:transform .1s ease, opacity .12s ease, filter .12s ease; box-shadow: 0 3px 12px rgba(0,0,0,.25); touch-action: manipulation; user-select:none; } .btn-odd{background:linear-gradient(180deg,#ef477a,#a41e48); border:1px solid #5e0f2b} .btn-even{background:linear-gradient(180deg,#25c994,#147a5d); border:1px solid #0c5541} .btn-rand{background:linear-gradient(180deg,#2e90ff,#0a3d9e); border:1px solid #0a2b69} .btn-ghost{background:linear-gradient(180deg,#0f1423,#0a0f1c); color:#cbd7f1; border:1px solid #1b263c} .theme-light .btn-ghost{ background:rgba(255,255,255,.7); color:#111; border-color:#d6d9e5 } button:hover{ transform: translateY(-1px) } button:active{ transform: translateY(0) scale(.98) } button[disabled]{ filter: grayscale(.35) brightness(.85) }

.stat-row{display:flex; flex-wrap:wrap; gap:8px} .stat{background:rgba(12,17,29,.5); border:1px solid #18233a; border-radius:10px; padding:8px 10px; font-size:12px} .theme-light .stat{ background:rgba(255,255,255,.6); border-color:#e3e7f2 } .display{margin-top:10px; background:rgba(12,17,29,.5); border:1px solid #18233a; border-radius:12px; padding:12px; font-weight:800; opacity:0; transform:translateY(6px); transition:opacity .2s, transform .2s} .display.show{opacity:1; transform:none} .theme-light .display{ background:rgba(255,255,255,.6); border-color:#e3e7f2 }

.grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:10px} .item{background:rgba(12,17,29,.5); border:1px solid #18233a; border-radius:12px; padding:10px; backdrop-filter: blur(10px)} .theme-light .item{ background:rgba(255,255,255,.6); border-color:#e3e7f2 } .muted{color:var(--muted)} .desc{ margin:6px 0 10px; font-size:12px; color:var(--muted) }

.log{display:grid; gap:8px; max-height:460px; overflow:auto} .row{display:flex; justify-content:space-between; gap:10px; background:rgba(12,17,29,.5); border:1px solid #18233a; border-radius:10px; padding:8px 10px; font-size:13px} .theme-light .row{ background:rgba(255,255,255,.6); border-color:#e3e7f2 } .pill{font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid #2b3a59} .pill.win{color:var(--good); border-color:rgba(25,227,161,.4)} .pill.lose{color:var(--bad); border-color:rgba(255,90,90,.45)} .pill.neutral{color:#a9b4cf}

/* ë™ì „ */ .coin{ width:90px; height:90px; margin:8px auto; perspective: 800px; } .coin-inner{ width:100%; height:100%; border-radius:50%; background: radial-gradient(55% 55% at 30% 30%, #ffe39b, #caa04d 70%, #8b6a29 100%), repeating-conic-gradient(from 0deg, rgba(255,255,255,.25) 0 2deg, transparent 2deg 6deg); border:2px solid #8d6a23; color:#2b1a00; font-weight:900; display:flex; align-items:center; justify-content:center; transform-style: preserve-3d; position: relative; will-change: transform; backface-visibility: hidden; } .coin-inner::after{ content:""; position:absolute; inset:0; border-radius:50%; background: radial-gradient(60% 60% at 30% 30%, rgba(255,255,255,.35), transparent 60%); mix-blend-mode: screen; pointer-events:none; } .coin-face{ transform: translateZ(2px) } .coin-inner.anim{ animation: coinflip .9s cubic-bezier(.2,.6,.2,1) } @keyframes coinflip{ 0%{ transform: rotateY(0deg) } 100%{ transform: rotateY(900deg) } }

/* ìŠ¬ë¡¯ */ .slot-frame{ margin:6px auto; padding:10px; border-radius:12px; background: linear-gradient(180deg,rgba(21,26,40,.7),rgba(12,17,29,.6)); border:1px solid #1b2438; box-shadow: inset 0 0 0 1px rgba(255,255,255,.03); } .reels{ display:flex; gap:8px; justify-content:center } .reel{ width:96px; height:64px; display:flex; align-items:center; justify-content:center; background:rgba(12,17,29,.55); border:1px solid #18233a; border-radius:10px; font-weight:900; font-size:18px; color:var(--text) } .sym-7{ color:#ff4d4d; text-shadow:0 0 6px rgba(255,77,77,.6) } .theme-light .reel{ background:rgba(255,255,255,.6); border-color:#e3e7f2; color:#111 } .theme-light .slot-frame{ background:#fff; border-color:#e3e7f2; box-shadow:none } .theme-light .sym-7{ color:#d22; text-shadow:none }

/* ì­íŒŸ ì´í™íŠ¸ */ .boom{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; z-index:10000} .boom.hide{display:none} .boom-text{font-size:76px; font-weight:900; color:#ffef9c; text-shadow:0 0 22px rgba(255,210,80,.7), 0 0 48px rgba(255,210,80,.35); text-align:center; transform:scale(0.9)} .ring{position:absolute; width:10px; height:10px; border:3px solid rgba(255,230,120,.8); border-radius:999px; opacity:.9; transform: scale(0) } .flash{position:absolute; inset:0; background:radial-gradient(ellipse at center, rgba(255,255,255,.55), transparent 60%); opacity:0} .beam{position:absolute; width:2px; height:38vh; background:linear-gradient(180deg, rgba(255,255,190,.0), rgba(255,255,160,.85), rgba(255,255,190,.0)); filter: blur(0.7px); transform-origin:center bottom; opacity:.0} .particle{position:absolute; width:6px; height:6px; background:#ffd74a; border-radius:2px; opacity:.9} .shake{ animation: shake .3s linear 3 } @keyframes shake{ 0%{transform:translate(0,0)} 25%{transform:translate(6px,-4px)} 50%{transform:translate(-6px,3px)} 75%{transform:translate(4px,5px)} 100%{transform:translate(0,0)} } .invert{ filter: invert(1) hue-rotate(180deg); transition: filter .3s }

/* ì´ˆê¸°í™” ë²„íŠ¼/íŒ¨ë„ */ #resetBtn{ position: fixed; right: 24px; bottom: 24px; z-index: 300 } #resetConfirm{ position:fixed; right:24px; bottom:84px; z-index:310; background:rgba(16,20,33,.6); border:1px solid var(--line); border-radius:14px; padding:12px; width:280px; display:none; backdrop-filter: blur(14px) saturate(1.1) } #resetConfirm .hint{ font-size:12px; color:var(--muted); margin:4px 0 } #resetConfirm input{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:rgba(240,245,255,.8); color:#111; margin:8px 0 } #resetConfirm .bar{ height:6px; background:var(--ghost,#0f1525); border:1px solid var(--line); border-radius:999px; overflow:hidden } #resetConfirm .bar > div{ height:100%; width:0%; background:linear-gradient(90deg,#2b8cff,#19e3a1) } #resetConfirm .row{ display:flex; gap:8px; margin-top:8px } #resetConfirm button{ flex:1 }

/* ê·¸ë˜í”„ */ #balanceChart{ width:100%; height:180px; background:rgba(16,20,33,.6); border:1px solid var(--line); border-radius:10px }

/* ì˜¤ë²„ë ˆì´(íŒŒì‚°/ìº¡ì°¨/ì´ë²¤íŠ¸/ìŠ¤í‚¬) */ .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:12000; background:rgba(0,0,0,.55); backdrop-filter: blur(8px); } .overlay.show{ display:flex } .modal{ background:rgba(16,20,33,.7); border:1px solid rgba(255,255,255,.08); padding:16px; border-radius:14px; width:min(92vw,420px); color:var(--text); text-align:center; box-shadow: 0 10px 32px rgba(0,0,0,.35); } .modal h3{ margin:0 0 10px; } .choices{ display:grid; gap:8px; } .tag{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.15); font-size:12px; color:var(--muted) }

@media (prefers-reduced-motion: reduce){ *{ animation: none !important; transition: none !important } } </style>

</head>
<body>
  <canvas id="fxCanvas"></canvas>  <!-- ìƒë‹¨ ì”ì•¡ ë°” -->  <div id="balanceBar" class="balance-bar">
    <div><b>ã€ë™ì–¸ë±ƒã€ v2</b></div>
    <div class="balance-pill">í˜„ì¬ ê¸ˆì•¡: <span id="balanceTop">0</span></div>
    <div class="balance-pill">ì­íŒŸ: <span id="jackpotTop">â‚© 1,200,000</span> (<span id="jackpotP"></span>)</div>
    <div class="balance-pill">ëŒ€ì¶œ í•œë„: <span id="loanCapTop">0</span></div>
  </div>  <div class="container">
    <!-- í—¤ë” -->
    <section class="card">
      <div class="title">
        <h1>ã€ë™ì–¸ë±ƒã€</h1>
        <div class="sub">ì„œë²„ ìƒíƒœ: ì •ìƒ Â· í˜„ì¬ ê¸°ë³¸ ìŠ¹ë¥ : <b id="p-global">47%</b> Â· ë‚œì´ë„ ìŠ¤ì¼€ì¼: <b id="diff">1.00x</b></div>
      </div>
      <div class="jackpot">
        <div>JACKPOT <span class="num" id="jackpot">â‚© 1,200,000</span></div>
        <div class="sub">í™•ë¥ : <b id="jackpotP2"></b> / í”Œë ˆì´</div>
      </div><div class="stat-row" style="margin-top:8px">
    <div class="stat">ìŠ¹ë¦¬: <b id="wins">0</b></div>
    <div class="stat">íŒ¨ë°°: <b id="losses">0</b></div>
    <div class="stat">ìµœëŒ€ ë³´ìœ ê¸ˆ: <b id="peak">0</b></div>
    <div class="stat">ì—­ëŒ€ ìµœì†Œê¸ˆ: <b id="minbal">0</b></div>
    <div class="stat">ì—…ì : <b id="ach">0</b></div>
  </div>
</section>

<!-- ì„¤ì •/ì—…ê·¸ë ˆì´ë“œ/ê¸ˆìœµ -->
<section class="card">
  <div class="title"><h2>í™˜ê²½ì„¤ì •</h2><div class="sub">ì •ë ¬/í…Œë§ˆ/íš¨ê³¼/ì—…ê·¸ë ˆì´ë“œ/ëŒ€ì¶œ ì •ì±… ì €ì¥ (ê¸€ë˜ìŠ¤ UI)</div></div>
  <div class="btn-row" style="gap:12px; align-items:center">
    <label>ë²„íŠ¼ ì •ë ¬:
      <select id="alignSelect" style="padding:8px 10px; border-radius:10px; border:1px solid var(--line); background:rgba(240,245,255,.6); color:var(--text)">
        <option value="flex-start">ì™¼ìª½</option>
        <option value="center">ê°€ìš´ë°</option>
        <option value="flex-end">ì˜¤ë¥¸ìª½</option>
      </select>
    </label>
    <label style="margin-left:10px">í…Œë§ˆ:
      <select id="themeSelect" style="padding:8px 10px; border-radius:10px; border:1px solid var(--line); background:rgba(240,245,255,.6); color:var(--text)">
        <option value="dark">ë‹¤í¬</option>
        <option value="light">ë¼ì´íŠ¸</option>
      </select>
    </label>
    <label style="margin-left:10px; display:flex; gap:6px; align-items:center">
      <input id="fxToggle" type="checkbox" checked> ë°°ê²½ WebGL íš¨ê³¼
    </label>
    <button class="btn-ghost" id="savePref">ì ìš©</button>
  </div>

  <div class="btn-row" style="gap:12px; margin-top:10px; flex-wrap:wrap">
    <button class="btn-rand" id="upgradeWinBtn">ìŠ¹ë¥  ì—…ê·¸ë ˆì´ë“œ</button>
    <button class="btn-rand" id="upgradeJpBtn">ì­íŒŸ í™•ë¥  ì—…ê·¸ë ˆì´ë“œ</button>
    <button class="btn-ghost" id="boostJpMode">ì­íŒŸ ëª¨ë“œ(10ì´ˆ)</button>
    <div class="stat">ë³´ë„ˆìŠ¤: <b id="bonusPct">+0%</b></div>
    <div class="stat">JP ë³´ë„ˆìŠ¤: <b id="bonusJp">+0.00%</b></div>
    <div class="stat">ë‹¤ìŒ ë¹„ìš©: <b id="nextCost">â‚© 100,000</b></div>
  </div>

  <div class="btn-row" style="gap:12px; margin-top:10px; flex-wrap:wrap">
    <div class="stat">ëŒ€ì¶œ ì”ì•¡: <b id="loanOut">â‚© 0</b></div>
    <div class="stat">í˜„ì¬ ì´ì(ì´ˆë‹¹): <b id="loanRate">â‚© 0</b></div>
    <div class="stat">ìµœëŒ€ ëŒ€ì¶œ í•œë„: <b id="loanCap">â‚© 0</b></div>
  </div>
  <div class="btn-row" style="gap:8px; margin-top:8px">
    <input id="loanAmt" type="number" placeholder="ê¸ˆì•¡(ì›)" min="0" step="1000" style="flex:1; min-width:120px; border-radius:10px; border:1px solid var(--line); background:rgba(240,245,255,.8); color:#111; padding:8px 10px">
    <button class="btn-odd" id="borrowBtn">ëˆ ë¹Œë¦¬ê¸°</button>
    <button class="btn-even" id="repayBtn">ëˆ ê°šê¸°</button>
  </div>

  <div class="btn-row" style="gap:8px; margin-top:10px">
    <label>ë² íŒ… ê¸ˆì•¡: <input id="betInput" type="number" min="100" step="100" value="1000" style="width:140px; border-radius:10px; padding:8px 10px; border:1px solid var(--line); background:rgba(240,245,255,.8); color:#111"></label>
    <span class="sub">(ì§ì ‘ ì¡°ì ˆ ê°€ëŠ¥)</span>
  </div>
</section>

<!-- í…Œì´ë¸” & í€µ ê²Œì„ -->
<section class="card">
  <div class="title"><h2>í…Œì´ë¸” & í€µ ê²Œì„</h2><div class="sub">í™€ì§ Â· ë™ì „ Â· í•˜ì´/ë¡œìš° Â· ì‚¬ë‹¤ë¦¬ â€” ìŠ¹ë¥ : <b class="pLive"></b></div></div>

  <div class="item" style="margin-bottom:10px">
    <h4>í™€ì§ <small>(ìŠ¹ë¥  <b class="pLive"></b>)</small></h4>
    <p class="desc">1,000ì˜ ìë¦¿ìˆ˜ë¡œ í™€/ì§ì„ ë§ì¶”ë©´ ìŠ¹ë¦¬. ìŠ¹ë¦¬ì‹œ ì„¤ì •ëœ ë°°ë‹¹(ì—…ê·¸ë ˆì´ë“œ/ë‚œì´ë„/ì´ë²¤íŠ¸ ë°˜ì˜)ìœ¼ë¡œ ì§€ê¸‰.</p>
    <div class="btn-row">
      <button class="btn-odd" id="oddBtn" aria-label="í™€ì§ ê²Œì„: í™€ì— ë² íŒ…">í™€ìˆ˜</button>
      <button class="btn-even" id="evenBtn" aria-label="í™€ì§ ê²Œì„: ì§ì— ë² íŒ…">ì§ìˆ˜</button>
      <button class="btn-ghost" id="resetBtn" aria-label="ì´ˆê¸°í™”">ì´ˆê¸°í™”</button>
    </div>
    <div id="result" class="display" aria-live="polite">ê²°ê³¼ ëŒ€ê¸°ì¤‘â€¦</div>
  </div>

  <div class="grid">
    <div class="item">
      <h4>ë™ì „ ë˜ì§€ê¸° <small>(ìŠ¹ë¥  <b class="pLive"></b>)</small></h4>
      <p class="desc">ì•/ë’¤ ì„ íƒ í›„ ëœë¤. ì—…ê·¸ë ˆì´ë“œì— ë”°ë¼ ìŠ¹ë¥ /ë°°ë‹¹ì´ ë‹¬ë¼ì§.</p>
      <div class="coin"><div id="coinFace" class="coin-inner"><div class="coin-face">ì•</div></div></div>
      <div class="btn-row">
        <button class="btn-odd" id="coinH">ì•</button>
        <button class="btn-even" id="coinT">ë’¤</button>
      </div>
      <div id="coinResult" class="display">ê²°ê³¼ ëŒ€ê¸°ì¤‘â€¦</div>
    </div>

    <div class="item">
      <h4>í•˜ì´ / ë¡œìš° <small>(ìŠ¹ë¥  <b class="pLive"></b>)</small></h4>
      <p class="desc">1~100 ì¤‘ ëœë¤ ìˆ˜. 50 ì´ˆê³¼ë©´ HIGH, ì´í•˜ë©´ LOW. ì„ íƒì´ ë§ìœ¼ë©´ ìŠ¹ë¦¬.</p>
      <div id="odometer" class="odometer">â€”</div>
      <div class="btn-row">
        <button class="btn-odd" id="lowBtn">LOW</button>
        <button class="btn-even" id="highBtn">HIGH</button>
      </div>
      <div id="hlResult" class="display">ê²°ê³¼ ëŒ€ê¸°ì¤‘â€¦</div>
    </div>

    <div class="item">
      <h4>ì‚¬ë‹¤ë¦¬ <small>(ìŠ¹ë¥  <b class="pLive"></b>)</small></h4>
      <p class="desc">ì¢Œ/ìš° ì¤‘ ì„ íƒí•´ ì•„ë˜ê¹Œì§€ ë‚´ë ¤ê°€ê¸°. ê°€ë¡œì¤„ ìˆ˜ì— ë”°ë¼ ê²°ê³¼ê°€ ë‹¬ë¼ì§.</p>
      <canvas id="ladderCanvas" width="280" height="190" style="width:100%; background:rgba(240,245,255,.08); border:1px solid var(--line); border-radius:8px"></canvas>
      <div class="btn-row">
        <button class="btn-odd" id="ladderLeft">LEFT</button>
        <button class="btn-even" id="ladderRight">RIGHT</button>
      </div>
      <div id="ladderResult" class="display">ê²°ê³¼ ëŒ€ê¸°ì¤‘â€¦</div>
    </div>
  </div>
</section>

<!-- ìŠ¬ë¡¯ & ë£°ë › -->
<section class="card">
  <div class="title"><h2>ìŠ¬ë¡¯ & ë£°ë › ì¡´</h2><div class="sub">ë‹¨ê³„ ê°ì† Â· ê²°ê³¼ ë™ê¸°í™” Â· ì—­ì­íŒŸ Â· ê°•í™” ë³´ìƒ</div></div>
  <div class="grid">
    <div class="item">
      <h4>ë¯¸ë‹ˆ ìŠ¬ë¡¯ <small>(3ê°œ=Ã—2.5(ê°•í™”), 2ê°œ=Ã—0.4(ê°•í™”), <b class="sym-7">777=ì­íŒŸÃ—10(ê°•í™”)</b>)</small></h4>
      <p class="desc">ìŠ¤í•€ ê²°ê³¼ ì¡°í•©ì— ë”°ë¼ ë°°ë‹¹. v2ì—ì„œëŠ” ì†ìµì´ ëŒ€í­ ê°•í™”: ë¬´ë°°ë‹¹ì‹œ ì†ì‹¤ 30ë°°, 2ê°œ ì¼ì¹˜Ã—4, 3ê°œ ì¼ì¹˜Ã—75, 777ì€ Ã—100.</p>
      <div class="slot-frame">
        <div class="reels">
          <div id="reel1" class="reel">-</div>
          <div id="reel2" class="reel">-</div>
          <div id="reel3" class="reel">-</div>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn-rand" id="slotBtn">ìŠ¤í•€</button>
      </div>
      <div id="slotResult" class="display">ê²°ê³¼ ëŒ€ê¸°ì¤‘â€¦</div>
    </div>

    <div class="item">
      <h4>ë£°ë › <small>(ìƒ‰ìƒë² íŒ… ìŠ¹ë¥  <b class="pLive"></b>)</small></h4>
      <p class="desc">0~36. ìƒ‰ìƒ 1:1, ìˆ«ì 35:1. ë‚œì´ë„/ì—…ê·¸ë ˆì´ë“œ ì˜í–¥ì„ ë°›ìŒ.</p>
      <div class="muted">0~36 Â· ìƒ‰ìƒ 1:1, ìˆ«ì 35:1</div>
      <div id="rouletteSpin" class="display">ëŒ€ê¸°ì¤‘â€¦</div>
      <div class="btn-row" style="margin-top:8px">
        <button class="btn-odd" data-roulette="RED">RED</button>
        <button class="btn-even" data-roulette="BLACK">BLACK</button>
      </div>
      <div class="btn-row" style="margin-top:6px">
        <input id="rouletteNum" type="number" placeholder="ìˆ«ì(0~36)" min="0" max="36" style="flex:1; min-width:120px; border-radius:10px; border:1px solid var(--line); background:rgba(240,245,255,.8); color:#111; padding:8px 10px">
        <button class="btn-ghost" id="rouletteNumBtn">ìˆ«ì ë² íŒ…</button>
      </div>
      <div id="rouletteResult" class="display">ê²°ê³¼ ëŒ€ê¸°ì¤‘â€¦</div>
    </div>
  </div>
</section>

<!-- ë¡œê·¸ + ê·¸ë˜í”„ -->
<section class="card">
  <div class="title"><h2>ë² íŒ… ë¡œê·¸</h2><div class="sub">ìµœê·¼ 100ê°œ & ë³´ìœ ê¸ˆ ê·¸ë˜í”„ Â· íƒ€ì„ë¼ì¸</div></div>
  <div id="log" class="log"></div>
  <canvas id="balanceChart" width="1040" height="180" aria-label="ë³´ìœ ê¸ˆ ê·¸ë˜í”„" role="img"></canvas>
</section>

  </div>  <!-- ì­íŒŸ FX -->  <div id="boom" class="boom hide" aria-hidden="true">
    <div class="boom-text">777 JACKPOT!</div>
    <div class="flash" id="flash"></div>
    <div class="ring" id="ring"></div>
  </div>  <!-- ì´ˆê¸°í™” í™•ì¸ íŒ¨ë„ -->  <div id="resetConfirm" aria-modal="true" role="dialog">
    <div class="hint">ì´ˆê¸°í™”ë¥¼ ì§„í–‰í•˜ë ¤ë©´ <b>RESET</b>ì„ ì…ë ¥í•˜ì„¸ìš”.</div>
    <input id="resetInput" placeholder="RESET" />
    <div class="hint">3ì´ˆ ëŒ€ê¸° í›„ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.</div>
    <div class="bar"><div id="resetBar"></div></div>
    <div class="row">
      <button class="btn-ghost" id="resetCancel">ì·¨ì†Œ</button>
      <button class="btn-odd" id="resetDo" disabled>ì™„ì „ ì´ˆê¸°í™”</button>
    </div>
    <div class="hint" id="resetCooldownHint" style="display:none"></div>
  </div>  <!-- íŒŒì‚° ì˜¤ë²„ë ˆì´ -->  <div id="bankruptOverlay" class="overlay" aria-modal="true" role="dialog">
    <div class="modal">
      <h3>íŒŒì‚°í–ˆìŠµë‹ˆë‹¤ ğŸ’¥</h3>
      <p>í™”ë©´ì„ ì ì‹œ ì–´ë‘¡ê²Œ í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
      <div style="display:flex; gap:8px; justify-content:center; margin-top:8px">
        <button class="btn-ghost" id="bkCancel">ì•„ë‹ˆì˜¤</button>
        <button class="btn-rand" id="bkRestart">ë‹¤ì‹œ ì‹œì‘</button>
      </div>
    </div>
  </div>  <!-- ìº¡ì°¨ ì˜¤ë²„ë ˆì´ -->  <div id="captchaOverlay" class="overlay" aria-modal="true" role="dialog">
    <div class="modal">
      <h3>ì ê¹! ì‚¬ëŒì¸ì§€ í™•ì¸ ğŸ‘€</h3>
      <p id="captchaQ">7 + 5 = ?</p>
      <input id="captchaA" placeholder="ì •ë‹µ" style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:rgba(240,245,255,.85); color:#111">
      <div style="display:flex; gap:8px; justify-content:center; margin-top:8px">
        <button class="btn-ghost" id="captchaCancel">ì·¨ì†Œ</button>
        <button class="btn-rand" id="captchaOk">í™•ì¸</button>
      </div>
      <div class="hint">ì­íŒŸ/ì—­ì­íŒŸ ì´í›„ ì¼ì • ì‹œê°„ ì…ë ¥ì´ ì ì‹œ ë¹„í™œì„±í™” ë©ë‹ˆë‹¤.</div>
    </div>
  </div>  <!-- ì´ë²¤íŠ¸ ì˜¤ë²„ë ˆì´ -->  <div id="eventOverlay" class="overlay" aria-modal="true" role="dialog">
    <div class="modal">
      <h3>í–‰ìš´ì˜ ì¹´ë“œ âœ¨</h3>
      <p class="muted">ëœë¤ ë²„í”„/ë””ë²„í”„ê°€ ë°œìƒí•©ë‹ˆë‹¤.</p>
      <div class="choices" id="eventChoices"></div>
    </div>
  </div>  <!-- ìŠ¤í‚¬ì¹´ë“œ ì˜¤ë²„ë ˆì´ -->  <div id="skillOverlay" class="overlay" aria-modal="true" role="dialog">
    <div class="modal">
      <h3>ìŠ¤í‚¬ì¹´ë“œ ì„ íƒ ğŸƒ</h3>
      <p class="muted">100íšŒ ì‹œë„ë§ˆë‹¤ 1ê°œ ì„ íƒ</p>
      <div class="choices" id="skillChoices"></div>
    </div>
  </div><script>
(function(){ if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded', init);} else {init();} })();

function init(){
/* ===== ìƒìˆ˜/í‚¤ ===== */
const STORAGE_VER=2;
const START_BAL = 300_000; // ì‹œì‘ê¸ˆì•¡ â†‘
const BASE_JP_START = 1_200_000; // ì­íŒŸ ê¸°ë³¸ ë² ì´ìŠ¤ ì‹œì‘
const JACKPOT_MIN=500_000;
const JACKPOT_P_BASE = 0.0005; // 0.05%
const JACKPOT_P_STEP = 0.001; // ì—…ê¸€ë‹¹ +0.1%
let JACKPOT_GROWTH = 1.0; // ì¦ê°€ìœ¨ ê³„ìˆ˜ (ì´ë²¤íŠ¸/ìŠ¤í‚¬ ì˜í–¥)
const REVERSE_JP_P=0.001; // ì—­ì­íŒŸ í™•ë¥ (ë°©ì–´ ê°€ëŠ¥)
const INTEREST_RATE_BASE = 0.003; // ì´ˆë‹¹ 0.3%
const COST_SEQ = [100000,200000,400000,800000,1200000,1600000,2000000];
const RESET_COOLDOWN_SEC = 60;
const BASE_MAX_LOAN = 20_000_000; // ëŒ€ì¶œ ê¸°ë³¸ ìƒí•œ
const CAPTCHA_COOLDOWN_MS = 2500; // ì­íŒŸ/ì—­ì­íŒŸ í›„ ìº¡ì°¨ê¹Œì§€ ëŒ€ê¸°

/* ===== ìƒíƒœ ===== */
let balance=START_BAL, peak=0, minbal=0, wins=0, losses=0;
let jackpot=BASE_JP_START;
let slotBusy=false; let upLevel=0; // ìŠ¹ë¥  ë ˆë²¨
let jpLevel=0; // ì­íŒŸí™•ë¥  ë ˆë²¨
let loanPrincipal=0; let loansTaken=0; let loanTimer=null;
let balanceHistory=[];
let coinSpinTimer=null;
let playCount=0; // ì­íŒŸ ë² ì´ìŠ¤ ìƒìŠ¹/ë‚œì´ë„/ìŠ¤í‚¬ì¹´ë“œ íŠ¸ë¦¬ê±°
let lastTapTime=0; // iOS ë”ë¸”íƒ­ ë°©ì§€
let shieldReverse=0, shieldBankruptcy=0; // ë°©ì–´ê¶Œ
let noLoseUntil=0; // ì´ ì‹œê°„ê¹Œì§€ ì†ì‹¤ 0 ì²˜ë¦¬
let jackpotModeUntil=0; // ì­íŒŸ ëª¨ë“œ íƒ€ì´ë¨¸
let nextSkillTriple=0; // ë‹¤ìŒ ìŠ¤í‚¬ 3ë°°
let failureBias=0; // ì ì§„ì  ì‹¤íŒ¨ í™•ë¥ (+)
let rewardBoost=1.0; // ë³´ìƒ ì¦ê°€ ê³„ìˆ˜
let lastGlobalDisable=0; // ì „ì²´ ë²„íŠ¼ ë¹„í™œì„±í™” í•´ì œ ì‹œê°

/* ===== DOM ===== */
const $=s=>document.querySelector(s);
const $$=s=>[...document.querySelectorAll(s)];
const balanceTop=$("#balanceTop"), jackpotTop=$("#jackpotTop");
const peakEl=$("#peak"), minEl=$("#minbal"), winEl=$("#wins"), lossEl=$("#losses");
const resultDiv=$("#result"), logEl=$("#log");
const jackpotEl=$("#jackpot"), jpP=$("#jackpotP"), jpP2=$("#jackpotP2");
const coinRes=$("#coinResult"), coinFace=$("#coinFace");
const odo=$("#odometer"), hlRes=$("#hlResult");
const slotRes=$("#slotResult"), r1=$("#reel1"), r2=$("#reel2"), r3=$("#reel3");
const rouSpin=$("#rouletteSpin"), rouRes=$("#rouletteResult");
const alignSelect=$("#alignSelect"), themeSelect=$("#themeSelect"), fxToggle=$("#fxToggle");
const bonusPctEl=$("#bonusPct"), bonusJpEl=$("#bonusJp"), nextCostEl=$("#nextCost"), upgradeWinBtn=$("#upgradeWinBtn"), upgradeJpBtn=$("#upgradeJpBtn"), boostJpMode=$("#boostJpMode");
const fxCanvas=$("#fxCanvas");
const ladderCanvas=$("#ladderCanvas"), ladderRes=$("#ladderResult");
const loanOut=$("#loanOut"), loanRate=$("#loanRate"), loanAmt=$("#loanAmt"), loanCap=$("#loanCap"), loanCapTop=$("#loanCapTop");
const borrowBtn=$("#borrowBtn"), repayBtn=$("#repayBtn");
const chartCanvas=$("#balanceChart"), chartCtx=chartCanvas.getContext('2d');
const pGlobals=[...document.querySelectorAll('.pLive')]; const pGlobal=$("#p-global");
const ladderBtns=[$("#ladderLeft"), $("#ladderRight")];
const resetBtn=$("#resetBtn"), resetPanel=$("#resetConfirm"), resetInput=$("#resetInput"),
      resetBar=$("#resetBar"), resetDo=$("#resetDo"), resetCancel=$("#resetCancel"),
      resetCooldownHint=$("#resetCooldownHint");
const diffEl=$("#diff"), achEl=$("#ach");
const bankruptOverlay=$("#bankruptOverlay"), bkRestart=$("#bkRestart"), bkCancel=$("#bkCancel");
const captchaOverlay=$("#captchaOverlay"), captchaQ=$("#captchaQ"), captchaA=$("#captchaA"), captchaOk=$("#captchaOk"), captchaCancel=$("#captchaCancel");
const eventOverlay=$("#eventOverlay"), eventChoices=$("#eventChoices");
const skillOverlay=$("#skillOverlay"), skillChoices=$("#skillChoices");

/* ===== ìœ í‹¸ ===== */
const fmt=n=>n.toLocaleString("ko-KR");
function fmtKR(n){
  const a=Math.abs(n);
  if(a>=1e8) return (n/1e8).toFixed(a>=1e10?0:1)+"ì–µ";
  if(a>=1e6) return (n/1e6).toFixed(1)+"ë°±ë§Œ";
  if(a>=1e5) return (n/1e5).toFixed(1)+"ì‹­ë§Œ";
  if(a>=1e4) return (n/1e4).toFixed(a>=1e6?0:1)+"ë§Œ";
  return fmt(n);
}
const nowStr=()=>new Date().toLocaleString("ko-KR",{hour12:false});
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
function rng(p){ return Math.random() < p; }
function between(a,b){ return a + Math.random()*(b-a); }
const betAmt = ()=> clamp(Math.floor(+$("#betInput").value||1000), 100, Math.max(1000000, balance));

function setBtnDisabled(el,on){ el.disabled=on; el.style.opacity = on ? "0.55" : "1"; el.style.pointerEvents = on ? "none" : "auto"; }
function setGlobalInputs(on){
  const list=$$('button,input,select');
  list.forEach(el=>{
    if(el===captchaA) return; // ìº¡ì°¨ ì…ë ¥ í—ˆìš©
    if(on){ el.removeAttribute('disabled'); el.style.pointerEvents='auto'; }
    else{ el.setAttribute('disabled','disabled'); el.style.pointerEvents='none'; }
  });
}

/* iOS ë”ë¸”íƒ­ í™•ëŒ€ ë°©ì§€ */
window.addEventListener('touchend', (e)=>{
  const now=Date.now();
  if(now - lastTapTime < 350){ e.preventDefault(); }
  lastTapTime = now;
}, {passive:false});

document.addEventListener('gesturestart', (e)=> e.preventDefault());

/* ===== ìŠ¤í† ë¦¬ì§€/ë¡œê·¸(JSON) ===== */
const KEY={BAL:"bal",PEAK:"peak",MIN:"min",W:"wins",L:"loss",J:"jackpot",LOG:"logJSON",
           THEME:"theme",ALIGN:"align",FX:"fx",UP:"upLevel",JP:"jpLevel",
           LOAN:"loanPrincipal", LOANS_TAKEN:"loansTaken",
           RST_TS:"resetTimestamp", SH_REV:"shieldRev", SH_BK:"shieldBk",
           NL_UNTIL:"noLoseUntil", JP_MODE:"jpModeUntil", FAIL_BIAS:"failBias", REWARD_BOOST:"rewardBoost",
           VER:"ver" };

function pushLog(type,msg,pill="neutral"){
  const rec={t:Date.now(),type,msg,pill};
  let arr=[]; try{arr=JSON.parse(localStorage.getItem(KEY.LOG)||"[]");}catch(_){arr=[]}
  arr.unshift(rec); arr=arr.slice(0,100); localStorage.setItem(KEY.LOG, JSON.stringify(arr));
  renderLog(arr);
}
function renderLog(arr){
  logEl.innerHTML="";
  (arr||JSON.parse(localStorage.getItem(KEY.LOG)||"[]")).forEach(r=>{
    const row=document.createElement('div'); row.className='row';
    const left=document.createElement('span'); left.className='muted'; left.textContent=new Date(r.t).toLocaleString("ko-KR",{hour12:false});
    const mid=document.createElement('span'); mid.textContent=r.msg;
    const right=document.createElement('span'); right.className=`pill ${r.pill||'neutral'}`; right.textContent=r.type;
    row.append(left,mid,right); logEl.appendChild(row);
  });
}

function save(){
  try{
    localStorage.setItem(KEY.BAL,String(balance));
    localStorage.setItem(KEY.PEAK,String(peak));
    localStorage.setItem(KEY.MIN,String(minbal));
    localStorage.setItem(KEY.W,String(wins));
    localStorage.setItem(KEY.L,String(losses));
    localStorage.setItem(KEY.J,String(jackpot));
    localStorage.setItem(KEY.UP,String(upLevel));
    localStorage.setItem(KEY.JP,String(jpLevel));
    localStorage.setItem(KEY.LOAN,String(loanPrincipal));
    localStorage.setItem(KEY.LOANS_TAKEN,String(loansTaken));
    localStorage.setItem(KEY.SH_REV,String(shieldReverse));
    localStorage.setItem(KEY.SH_BK,String(shieldBankruptcy));
    localStorage.setItem(KEY.NL_UNTIL,String(noLoseUntil));
    localStorage.setItem(KEY.JP_MODE,String(jackpotModeUntil));
    localStorage.setItem(KEY.FAIL_BIAS,String(failureBias));
    localStorage.setItem(KEY.REWARD_BOOST,String(rewardBoost));
    localStorage.setItem(KEY.VER,String(STORAGE_VER));
  }catch(_){}
}
function load(){
  try{
    const ver=+(localStorage.getItem(KEY.VER)||0);
    if(ver!==STORAGE_VER){ localStorage.setItem(KEY.VER,String(STORAGE_VER)); }
    const g=(k)=>+localStorage.getItem(k);
    let b=localStorage.getItem(KEY.BAL);
    balance = (b===null)?START_BAL:+b; if(!Number.isFinite(balance)) balance=START_BAL;
    peak = Number.isFinite(g(KEY.PEAK))?g(KEY.PEAK):0;
    minbal = Number.isFinite(g(KEY.MIN))?g(KEY.MIN):balance;
    wins = Number.isFinite(g(KEY.W))?g(KEY.W):0;
    losses = Number.isFinite(g(KEY.L))?g(KEY.L):0;
    jackpot = Number.isFinite(g(KEY.J))?g(KEY.J):BASE_JP_START;
    upLevel = Number.isFinite(g(KEY.UP)) ? g(KEY.UP) : 0;
    jpLevel = Number.isFinite(g(KEY.JP)) ? g(KEY.JP) : 0;
    loanPrincipal = Number.isFinite(g(KEY.LOAN)) ? g(KEY.LOAN) : 0;
    loansTaken = Number.isFinite(g(KEY.LOANS_TAKEN)) ? g(KEY.LOANS_TAKEN) : 0;
    shieldReverse = Number.isFinite(g(KEY.SH_REV)) ? g(KEY.SH_REV) : 0;
    shieldBankruptcy = Number.isFinite(g(KEY.SH_BK)) ? g(KEY.SH_BK) : 0;
    noLoseUntil = Number.isFinite(g(KEY.NL_UNTIL)) ? g(KEY.NL_UNTIL) : 0;
    jackpotModeUntil = Number.isFinite(g(KEY.JP_MODE)) ? g(KEY.JP_MODE) : 0;
    failureBias = Number.isFinite(g(KEY.FAIL_BIAS)) ? g(KEY.FAIL_BIAS) : 0;
    rewardBoost = Number.isFinite(g(KEY.REWARD_BOOST)) ? g(KEY.REWARD_BOOST) : 1.0;
    renderLog();
  }catch(_){ balance=START_BAL; jackpot=BASE_JP_START; }
}

/* ===== ë‚œì´ë„/í™•ë¥ /ë°°ë‹¹ ===== */
function pWinBase(){ // ì—…ê¸€(+), ë‚œì´ë„(-)
  const base = 0.47 + upLevel*0.01; // ì—…ê¸€ì€ +1%ì”©
  const penalty = clamp(failureBias, 0, 0.18); // ìµœëŒ€ 18% ë¶ˆë¦¬
  return clamp(base - penalty, 0.01, 0.9);
}
function pWin(){
  let p = pWinBase();
  // ì­íŒŸ ëª¨ë“œì¼ ë• ì¼ë°˜ ê²Œì„ ìŠ¹ë¥ ì€ ì†Œí­ ìƒí–¥(ì¬ë¯¸ ìš”ì†Œ)
  if(Date.now() < jackpotModeUntil) p += 0.02;
  return clamp(p, 0.01, 0.95);
}
function currentJpProb(){
  let p = JACKPOT_P_BASE + jpLevel*JACKPOT_P_STEP; // ê¸°ë³¸ + ì—…ê¸€
  if(Date.now() < jackpotModeUntil) p += 0.02; // ëª¨ë“œ ë²„í”„(2%)
  return clamp(p, 0, 0.2); // ìƒí•œ 20%
}
function nextCost(){
  const base = (upLevel + jpLevel < COST_SEQ.length) ? COST_SEQ[upLevel + jpLevel] : COST_SEQ[COST_SEQ.length-1] + (upLevel + jpLevel - COST_SEQ.length + 1) * 400000;
  return base;
}
function currentInterest(){
  const rate = INTEREST_RATE_BASE * (1 + loansTaken*0.15); // ëŒ€ì¶œ íšŸìˆ˜ ê°€ì¤‘ì¹˜
  return rate;
}
function loanCapCalc(){
  const ir = currentInterest(); // ex 0.003
  const irNorm = clamp((ir - INTEREST_RATE_BASE) / INTEREST_RATE_BASE, 0, 2); // 0~2
  const jpNorm = clamp(currentJpProb() / 0.02, 0, 1); // 0~1 (2%ë¥¼ ë†’ì€ í¸ìœ¼ë¡œ ê°„ì£¼)
  const cap = Math.floor(BASE_MAX_LOAN * (1 - 0.5*irNorm) * (1 - 0.7*jpNorm));
  return Math.max(0, cap);
}

function updateLiveP(){
  const pct = (pWin()*100).toFixed(1)+"%";
  pGlobal.textContent=pct; pGlobals.forEach(el=>el.textContent=pct);
  const diffScale = (1 + failureBias).toFixed(2) + 'x';
  diffEl.textContent = diffScale;
}

function updateUI(){
  peak=Math.max(peak,balance); if(minbal===0) minbal=balance; minbal=Math.min(minbal,balance);
  balanceTop.textContent=fmt(balance);
  jackpotEl.textContent="â‚© "+fmt(jackpot); jackpotTop.textContent="â‚© "+fmt(jackpot);
  jpP.textContent=(currentJpProb()*100).toFixed(2)+"%"; jpP2.textContent=(currentJpProb()*100).toFixed(2)+"%";
  bonusPctEl.textContent = `+${(upLevel).toFixed(0)}%`;
  bonusJpEl.textContent = `+${(jpLevel*JACKPOT_P_STEP*100).toFixed(2)}%`;
  nextCostEl.textContent = "â‚© "+fmt(nextCost());
  peakEl.textContent=fmt(peak); minEl.textContent=fmt(minbal);
  winEl.textContent=wins; lossEl.textContent=losses;
  const rate = Math.floor(loanPrincipal * currentInterest());
  loanOut.textContent = "â‚© "+fmt(loanPrincipal);
  loanRate.textContent = "â‚© "+fmt(rate);
  const cap = loanCapCalc(); loanCap.textContent = "â‚© "+fmt(cap); loanCapTop.textContent = fmt(cap);
  updateLiveP();
  save();
}

function applyDelta(delta,label,{countWL=true,pill}={}){
  // ì†ì‹¤ ë¬´íš¨ ë²„í”„
  if(delta<0 && Date.now() < noLoseUntil) {
    pushLog('ë²„í”„', `ì†ì‹¤ ë¬´íš¨: ${label}`, 'neutral');
    delta = 0;
  }
  const before=balance; balance+=delta;
  if(countWL){ if(delta>0) wins++; else if(delta<0) losses++; }
  updateUI();
  const pillClass = pill ? pill : (countWL ? (delta>0?"win":"lose") : "neutral");
  pushLog("ì”ì•¡",`${label} ${delta>0?"+":"-"}${fmt(Math.abs(delta))} â†’ ${fmt(before)} â–¶ ${fmt(balance)}`, pillClass);
  recordBalancePoint();
  checkAchievements();
  if(balance<0) onBankrupt();
}

function bumpPlay(){
  playCount++;
  // ì ì§„ì  ë‚œì´ë„: ì‹¤íŒ¨ í™•ë¥ (íŒ¨ë„í‹°) ì¦ê°€ + ë³´ìƒë„ ì†Œí­ ì¦ê°€
  failureBias = clamp( (playCount/4000)*0.08 + (loanPrincipal>0?0.01:0), 0, 0.18 );
  rewardBoost = clamp(1 + playCount/5000, 1, 1.6);
  // 100íšŒë§ˆë‹¤ ìŠ¤í‚¬ì¹´ë“œ
  if(playCount>0 && playCount % 100 === 0) openSkillCards();
}

/* ===== ì­íŒŸ ë² ì´ìŠ¤(ì ì§„ ìƒìŠ¹/ëŠë¦¬ê²Œ) ===== */
function baseJackpot(){
  const byLevel = upLevel * 120_000;
  const byPlay  = Math.min(400_000, playCount*400); // ì™„ë§Œ/â†“
  return BASE_JP_START + byLevel + byPlay;
}

/* ===== ì­íŒŸ FX ===== */
function jackpotFX(kind="pos"){
  const layer=$("#boom"), flash=$("#flash"), ring=$("#ring"), text=layer.querySelector(".boom-text");
  text.textContent = kind==="neg" ? "REVERSE JACKPOT!" : "777 JACKPOT!";
  text.style.color = kind==="neg" ? "#ff9ca0" : "#ffef9c";
  text.style.textShadow = kind==="neg"
    ? "0 0 18px rgba(255,100,120,.55), 0 0 42px rgba(255,60,80,.25)"
    : "0 0 22px rgba(255,210,80,.7), 0 0 48px rgba(255,210,80,.35)";
  layer.classList.remove("hide");
  document.body.classList.add('shake','invert');
  setTimeout(()=>document.body.classList.remove('shake','invert'), 600);
  text.animate([{transform:"scale(.9)",opacity:.6},{transform:"scale(1.06)",opacity:1},{transform:"scale(1)",opacity:.95}],{duration:700,easing:"cubic-bezier(.2,.7,.2,1)"});
  if(flash) flash.animate([{opacity:0},{opacity:.9},{opacity:0}], {duration:420, easing:"ease-out"});
  if(ring)  ring.animate([{transform:"scale(0)", opacity:.9},{transform:"scale(18)", opacity:0}], {duration:820, easing:"cubic-bezier(.2,.7,.2,1)"});
  const beams=24, cx=innerWidth/2, cy=innerHeight/2;
  for(let i=0;i<beams;i++){
    const b=document.createElement("div"); b.className="beam";
    b.style.left=cx+"px"; b.style.top=cy+"px"; b.style.transform=`translate(-1px,0) rotate(${(360/beams)*i}deg)`;
    layer.appendChild(b);
    b.animate([{opacity:0,transform:b.style.transform+" scaleY(0.3)"},{opacity:.9,transform:b.style.transform+" scaleY(1)"},{opacity:0,transform:b.style.transform+" scaleY(0.2)"}],{duration:700,easing:"ease-out"}).onfinish=()=>b.remove();
  }
  const N=28;
  for(let i=0;i<N;i++){
    const p=document.createElement("div"); p.className="particle";
    p.style.left=cx+"px"; p.style.top=cy+"px"; p.style.transform=`translate(0,0)`; layer.appendChild(p);
    const angle=(Math.PI*2)*(i/N), speed=(140+Math.random()*140)*(kind==="neg"?0.8:1);
    const vx=Math.cos(angle)*speed, vy=Math.sin(angle)*speed-(kind==="neg"?30:60); const start=performance.now();
    (function anim(t0){ const dt=(t0-start)/1000; const x=vx*dt, y=vy*dt + 140*dt*dt;
      p.style.background= kind==="neg" ? "#ff7080" : "#ffd74a";
      p.style.transform=`translate(${x}px, ${y}px)`; p.style.opacity=String(Math.max(0,1-dt/0.9));
      if(dt<0.9) requestAnimationFrame(anim); else p.remove();
    })(start);
  }
  setTimeout(()=>layer.classList.add("hide"), 900);
}

/* ===== WebGL FX (ì›ë³¸ ìœ ì§€) ===== */
const FX = (function(){
  let gl, prog, tLoc, rLoc, anim=0, start=0, running=false;
  const vs = `attribute vec2 p; void main(){ gl_Position = vec4(p,0.0,1.0); }`;
  const fs = `
  precision mediump float; uniform float u_time; uniform vec2 u_res;
  void main(){
    vec2 uv = (gl_FragCoord.xy/u_res)-0.5; uv.x *= u_res.x/u_res.y;
    float t = u_time*0.9;
    float r = length(uv);
    float ring = 0.6 + 0.4*sin(18.0*r - t*7.0);
    float twirl = sin( (uv.x*8.0 - uv.y*6.5) + t*2.6 );
    float spark = smoothstep(0.965,1.0, sin( (uv.x+uv.y+t*2.1)*65.0 ));
    vec3 col = vec3(0.10,0.12,0.20);
    col += 0.65*ring*vec3(1.0,0.85,0.25);
    col += 0.28*twirl*vec3(0.25,0.6,1.0);
    col += 1.0*spark*vec3(1.0,0.95,0.5);
    gl_FragColor = vec4(col, 0.35);
  }`;
  function sh(gl,t,src){const s=gl.createShader(t);gl.shaderSource(s,src);gl.compileShader(s);if(!gl.getShaderParameter(s,gl.COMPILE_STATUS)){console.error(gl.getShaderInfoLog(s));return null;}return s;}
  function init(){
    if(running || gl) return;
    const glc = fxCanvas.getContext('webgl', { antialias:false, depth:false, stencil:false, alpha:true, premultipliedAlpha:false });
    if(!glc){ console.warn('WebGL not available'); return; }
    gl = glc;
    function resize(){ fxCanvas.width = innerWidth; fxCanvas.height = innerHeight; gl.viewport(0,0,fxCanvas.width,fxCanvas.height); }
    addEventListener('resize', resize); resize();
    const v=sh(gl,gl.VERTEX_SHADER,vs), f=sh(gl,gl.FRAGMENT_SHADER,fs);
    prog=gl.createProgram(); gl.attachShader(prog,v); gl.attachShader(prog,f); gl.linkProgram(prog);
    if(!gl.getProgramParameter(prog, gl.LINK_STATUS)){ console.error(gl.getProgramInfoLog(prog)); return; }
    gl.useProgram(prog);
    const buf=gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER,buf);
    gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1, 1,-1, -1,1, 1,1]),gl.STATIC_DRAW);
    const pLoc=gl.getAttribLocation(prog,'p'); gl.enableVertexAttribArray(pLoc); gl.vertexAttribPointer(pLoc,2,gl.FLOAT,false,0,0);
    tLoc=gl.getUniformLocation(prog,'u_time'); rLoc=gl.getUniformLocation(prog,'u_res');
    gl.enable(gl.BLEND); gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
  }
  function startLoop(){
    if(!gl) return;
    start=performance.now();
    function loop(now){
      if(!running) return;
      const t=(now-start)/1000;
      gl.uniform1f(tLoc,t); gl.uniform2f(rLoc, fxCanvas.width, fxCanvas.height);
      gl.drawArrays(gl.TRIANGLE_STRIP,0,4);
      anim=requestAnimationFrame(loop);
    }
    anim=requestAnimationFrame(loop);
  }
  return { start(){ if(running) return; init(); if(!gl) return; fxCanvas.style.display='block'; running=true; startLoop(); }, stop(){ running=false; if(anim) cancelAnimationFrame(anim); fxCanvas.style.display='none'; } };
})();

/* ===== í™˜ê²½ì„¤ì •/ì—…ê·¸ë ˆì´ë“œ ===== */
(function(){
  const a = localStorage.getItem(KEY.ALIGN) || "flex-start";
  const t = localStorage.getItem(KEY.THEME) || "dark";
  const fxStored = localStorage.getItem(KEY.FX);
  const fxOn = (fxStored===null) ? true : (fxStored==="1");
  upLevel = +(localStorage.getItem(KEY.UP)||0);
  jpLevel = +(localStorage.getItem(KEY.JP)||0);
  document.documentElement.style.setProperty('--btn-justify', a);
  document.body.classList.toggle('theme-light', t==='light');
  alignSelect.value = a; themeSelect.value = t; fxToggle.checked = fxOn;
  if(fxOn) FX.start(); else FX.stop();

  $("#savePref").addEventListener("click", ()=>{
    const na = alignSelect.value; const nt = themeSelect.value; const nfx = fxToggle.checked;
    document.documentElement.style.setProperty('--btn-justify', na);
    document.body.classList.toggle('theme-light', nt==='light');
    localStorage.setItem(KEY.ALIGN, na); localStorage.setItem(KEY.THEME, nt); localStorage.setItem(KEY.FX, nfx ? "1" : "0");
    if(nfx) FX.start(); else FX.stop();
    drawChart();
  });

  upgradeWinBtn.addEventListener("click", ()=>{
    const cost = nextCost();
    if(balance < cost){ pushLog("ì—…ê·¸ë ˆì´ë“œ","ì”ì•¡ ë¶€ì¡±","neutral"); return; }
    applyDelta(-cost, "ìŠ¹ë¥  ì—…ê·¸ë ˆì´ë“œ ê²°ì œ");
    upLevel++; // ìŠ¹ë¥  +1%
    pushLog("ì—…ê·¸ë ˆì´ë“œ",`ìŠ¹ë¥  ë³´ë„ˆìŠ¤ +1% (ë ˆë²¨ ${upLevel})`,`win`);
    updateUI();
  });

  upgradeJpBtn.addEventListener("click", ()=>{
    const cost = nextCost();
    if(balance < cost){ pushLog("ì—…ê·¸ë ˆì´ë“œ","ì”ì•¡ ë¶€ì¡±","neutral"); return; }
    applyDelta(-cost, "ì­íŒŸ í™•ë¥  ì—…ê·¸ë ˆì´ë“œ ê²°ì œ");
    jpLevel++; // ì­íŒŸí™•ë¥  +0.1%
    // ì­íŒŸ í™•ë¥  ì—…ê¸€ ì‹œ, ë°°ë‹¹ë„ ì•½ê°„ ê°•í™”(ë³´ìƒ ê³„ìˆ˜)
    rewardBoost = clamp(rewardBoost * 1.03, 1, 2);
    pushLog("ì—…ê·¸ë ˆì´ë“œ",`JPí™•ë¥  +0.1% (ë ˆë²¨ ${jpLevel}) Â· ë³´ìƒê°•í™”`,`win`);
    updateUI();
  });

  boostJpMode.addEventListener('click', ()=>{
    const cost = 150000; if(balance < cost){ pushLog('ì­íŒŸëª¨ë“œ','ì”ì•¡ ë¶€ì¡±','neutral'); return; }
    applyDelta(-cost, 'ì­íŒŸ ëª¨ë“œ ì§„ì…(10ì´ˆ)');
    jackpotModeUntil = Date.now() + 10000; save(); updateUI();
  });
})();

/* ===== ì•ˆë‚´(í† ìŠ¤íŠ¸ ëŒ€ì²´) ===== */
(function(){ const msgs=["í™˜ì˜í•©ë‹ˆë‹¤! ë™ì–¸ë±ƒ v2.","ê²Œì„ì€ ì¬ë¯¸ë¡œë§Œ! ê³¼ëª°ì… ê¸ˆì§€."]; let i=0; const div=document.createElement('div'); div.style.cssText='position:fixed;left:50%;top:10px;transform:translateX(-50%);z-index:20000;background:rgba(16,20,33,.8);backdrop-filter:blur(10px);padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.08);font-weight:800'; document.body.appendChild(div); function next(){ if(i>=msgs.length){div.remove(); return;} div.textContent=msgs[i++]; setTimeout(next,1200);} next(); })();

/* ===== ì­íŒŸ ì¦ì•¡(ëŠë¦¬ê²Œ, ì„±ì¥ ê³„ìˆ˜ ì ìš©) ===== */
(function incJP(){
  const interestWonPerSec = Math.floor(loanPrincipal * currentInterest());
  const levelBoost = upLevel * 120;
  const baseAdd  = 120 + Math.floor(Math.random()*220); // â†“ ëŠë¦¬ê²Œ
  const bonusAdd = Math.floor(interestWonPerSec * 0.25) + levelBoost;
  jackpot += Math.floor((baseAdd + bonusAdd) * JACKPOT_GROWTH);
  updateUI();

  const fasterI = Math.min(500, Math.floor(interestWonPerSec / 6));
  const fasterL = Math.min(420, upLevel * 26);
  const delay = Math.max(140, 620 + Math.floor(Math.random()*520) - fasterI - fasterL);
  setTimeout(incJP, delay);
})();

/* ===== ì­íŒŸ/ì—­ì­íŒŸ ì²´í¬(ìº¡ì°¨+ì¿¨ë‹¤ìš´) ===== */
function afterJackpotCooldown(){
  lastGlobalDisable = Date.now() + CAPTCHA_COOLDOWN_MS;
  setGlobalInputs(false);
  setTimeout(()=>{
    openCaptcha(()=>{
      setGlobalInputs(true);
    });
  }, CAPTCHA_COOLDOWN_MS);
}

function jackpotChecks(ctx="ê²Œì„", baseBet=0){
  if(rng(REVERSE_JP_P)){
    if(shieldReverse>0){ shieldReverse--; pushLog('ë°©ì–´','ì—­ì­íŒŸ 1íšŒ ë°©ì–´','neutral'); save(); return true; }
    const loss = Math.min(balance, jackpot);
    applyDelta(-loss, "REVERSE JACKPOT");
    jackpotFX("neg");
    pushLog("ì—­ì­íŒŸ",`-${fmt(loss)} (${ctx})","lose");
    afterJackpotCooldown();
    return true;
  }
  if(rng(currentJpProb())){
    if(baseBet>0){
      const prize = Math.floor(baseBet * 100); // 777 ì™¸ì—ë„ ìŠ¬ë¡¯ ì­íŒŸì€ ê°•í™” Ã—100
      applyDelta(+prize, "ìŠ¬ë¡¯ ì­íŒŸ");
    }else{
      const prize = jackpot;
      applyDelta(+prize, "JACKPOT");
      const bj = baseJackpot();
      jackpot = Math.max(JACKPOT_MIN, Math.floor(bj * (0.7 + Math.random()*0.2)));
      updateUI();
    }
    jackpotFX("pos");
    pushLog("JACKPOT",`+${fmt(baseBet?Math.floor(baseBet*100):jackpot)} (${ctx})","win");
    afterJackpotCooldown();
    return true;
  }
  return false;
}

/* ===== ê·¸ë˜í”„ (ê°œì„  ë¼ë²¨) ===== */
function setupChartCanvas(){
  const dpr = window.devicePixelRatio || 1;
  const cssW = Math.max(1, chartCanvas.clientWidth || chartCanvas.width);
  const cssH = Math.max(1, chartCanvas.clientHeight || chartCanvas.height);
  if (chartCanvas.width !== Math.round(cssW * dpr) || chartCanvas.height !== Math.round(cssH * dpr)) {
    chartCanvas.width  = Math.round(cssW * dpr);
    chartCanvas.height = Math.round(cssH * dpr);
  }
  chartCtx.setTransform(1,0,0,1,0,0);
  chartCtx.scale(dpr, dpr);
}
function recordBalancePoint(){
  const t = Date.now();
  balanceHistory.push([t,balance]);
  if(balanceHistory.length>1200) balanceHistory.shift();
  drawChart();
}
function drawChart(){
  setupChartCanvas();
  const w = chartCanvas.clientWidth || 1040;
  const h = chartCanvas.clientHeight || 180;
  const mL=60, mR=18, mT=24, mB=28;
  const innerW = Math.max(1, w - (mL+mR));
  const innerH = Math.max(1, h - (mT+mB));
  chartCtx.clearRect(0,0,w,h);

  chartCtx.strokeStyle = document.body.classList.contains('theme-light') ? "#d5dae6" : "#2b3a59";
  chartCtx.strokeRect(mL, mT, innerW, innerH);

  if(balanceHistory.length<2){
    chartCtx.fillStyle = document.body.classList.contains('theme-light') ? "#111" : "#cbd7f1";
    chartCtx.font = "12px ui-sans-serif";
    chartCtx.fillText("X: ì‹œê°„(ì´ˆ)", mL + innerW - 60, mT + innerH + 20);
    chartCtx.fillText("Y: ë³´ìœ ê¸ˆ(ìµœì €=0)", mL + 6, mT - 8);
    return;
  }

  const t0 = balanceHistory[0][0];
  const t1 = balanceHistory[balanceHistory.length-1][0];
  let minB = Infinity, maxB = -Infinity;
  for(const [,b] of balanceHistory){ if(b<minB) minB=b; if(b>maxB) maxB=b; }
  const rngB = Math.max(1, maxB - minB);

  chartCtx.font = "12px ui-sans-serif";
  chartCtx.textBaseline = "middle";

  // Yì¶•(ë‹¨ìœ„ ìë™)
  const yTickCount = 4;
  for(let i=0;i<=yTickCount;i++){
    const frac = i / yTickCount;
    const yVal = minB + rngB * frac;
    const y = mT + innerH - frac * innerH;

    chartCtx.strokeStyle = i===0 ? (document.body.classList.contains('theme-light') ? "#cbd5e1" : "#44557a") : (document.body.classList.contains('theme-light') ? "#e8ecf5" : "#23314e");
    chartCtx.beginPath(); chartCtx.moveTo(mL,y); chartCtx.lineTo(mL+innerW,y); chartCtx.stroke();

    const label = fmtKR(Math.round(yVal));
    const padX=6, padY=2;
    const textW = chartCtx.measureText(label).width;
    const boxX = mL - 8 - textW - padX*2, boxY = y - 10;
    chartCtx.fillStyle = document.body.classList.contains('theme-light') ? "rgba(255,255,255,.85)" : "rgba(10,12,19,.7)";
    chartCtx.fillRect(boxX, boxY, textW + padX*2, 20);
    chartCtx.strokeStyle = document.body.classList.contains('theme-light') ? "#d5dae6" : "#2b3a59";
    chartCtx.strokeRect(boxX, boxY, textW + padX*2, 20);

    chartCtx.fillStyle = document.body.classList.contains('theme-light') ? "#111" : "#eaf0ff";
    chartCtx.textAlign = "left";
    chartCtx.fillText(label, boxX + padX, y);
  }

  // Xì¶•
  const xTickCount = 8;
  const xStepIdx   = Math.max(1, Math.floor((balanceHistory.length-1)/xTickCount));
  chartCtx.textAlign = "center";
  for(let i=0, idx=0; idx<balanceHistory.length; i++, idx=i*xStepIdx){
    if(idx >= balanceHistory.length) break;
    const t = balanceHistory[idx][0];
    const xFrac = (t - t0) / (t1 - t0 || 1);
    const x = mL + xFrac * innerW;
    chartCtx.strokeStyle = document.body.classList.contains('theme-light') ? "#e8ecf5" : "#23314e";
    chartCtx.beginPath(); chartCtx.moveTo(x, mT); chartCtx.lineTo(x, mT+innerH); chartCtx.stroke();
    chartCtx.fillStyle = document.body.classList.contains('theme-light') ? "#111" : "#cbd7f1";
    chartCtx.fillText(Math.round((t - t0)/1000)+"s", x, mT+innerH + 14);
  }

  chartCtx.fillStyle = document.body.classList.contains('theme-light') ? "#111" : "#cbd7f1";
  chartCtx.textAlign = "left";  chartCtx.fillText("Y: ë³´ìœ ê¸ˆ (ë‹¨ìœ„ ìë™)", mL + 6, mT - 8);
  chartCtx.textAlign = "right"; chartCtx.fillText("X: ì‹œê°„(ì´ˆ)", mL + innerW, mT + innerH + 24);

  // ì„ 
  chartCtx.lineWidth = 2; chartCtx.strokeStyle = "#2b8cff";
  chartCtx.beginPath();
  balanceHistory.forEach(([t,b],i)=>{
    const xf = (t - t0) / (t1 - t0 || 1);
    const x  = mL + xf * innerW;
    const yv = (b - minB) / rngB;
    const y  = mT + innerH - yv * innerH;
    if(i===0) chartCtx.moveTo(x,y); else chartCtx.lineTo(x,y);
  });
  chartCtx.stroke();
}
addEventListener('resize', drawChart);

/* ===== ëŒ€ì¶œ(ì´ì ì°¨ê° + í•œë„) ===== */
function startLoanTimer(){
  if(loanTimer || loanPrincipal<=0) return;
  loanTimer = setInterval(()=>{
    if(loanPrincipal<=0){ clearInterval(loanTimer); loanTimer=null; return; }
    const interest = Math.floor(loanPrincipal * currentInterest());
    if(interest>0) applyDelta(-interest, "ëŒ€ì¶œ ì´ì", {countWL:false,pill:"neutral"});
    updateUI();
  }, 1000);
}
borrowBtn.addEventListener("click", ()=>{
  const amt = Math.max(0, Math.floor(+loanAmt.value||0)); if(amt<=0) return;
  const cap = loanCapCalc();
  const available = Math.max(0, cap - loanPrincipal);
  if(amt > available){ pushLog('ëŒ€ì¶œ','í•œë„ ì´ˆê³¼','lose'); return; }
  loanPrincipal += amt; loansTaken++; applyDelta(+amt, "ëŒ€ì¶œ");
  startLoanTimer(); updateUI();
});
repayBtn.addEventListener("click", ()=>{
  const amt = Math.max(0, Math.floor(+loanAmt.value||0)); if(amt<=0) return;
  const pay = Math.min(amt, balance, loanPrincipal);
  if(pay<=0) return;
  loanPrincipal -= pay; applyDelta(-pay, "ëŒ€ì¶œ ìƒí™˜");
  if(loanPrincipal<=0 && loanTimer){ clearInterval(loanTimer); loanTimer=null; }
  updateUI();
});

/* ===== íŒŒì‚° ì²˜ë¦¬ ===== */
function onBankrupt(){
  if(shieldBankruptcy>0){
    shieldBankruptcy--; pushLog('ë°©ì–´','íŒŒì‚° 1íšŒ ë°©ì–´ (í˜ë„í‹°: ì´ììœ¨ 2ë°° 10ì´ˆ)','neutral');
    // 10ì´ˆ ë™ì•ˆ ì´ììœ¨ 2ë°° íš¨ê³¼ë¥¼ loansTakenì— ê°€ì¤‘ì¹˜ë¡œ ë°˜ì˜(ê°„ë‹¨ ì²˜ë¦¬)
    const oldLoans=loansTaken; loansTaken += 5; setTimeout(()=>{ loansTaken = oldLoans; updateUI(); }, 10000);
    updateUI(); return;
  }
  bankruptOverlay.classList.add('show');
}
bkRestart.addEventListener('click', ()=>{ bankruptOverlay.classList.remove('show'); doReset(); });
bkCancel.addEventListener('click', ()=>{ bankruptOverlay.classList.remove('show'); });

/* ===== ìº¡ì°¨ ===== */
function openCaptcha(onOk){
  const a=Math.floor(3+Math.random()*7), b=Math.floor(3+Math.random()*7);
  captchaQ.textContent=`${a} + ${b} = ?`;
  captchaA.value=""; captchaOverlay.classList.add('show');
  function ok(){ if((+captchaA.value||0)===a+b){ captchaOverlay.classList.remove('show'); onOk&&onOk(); cleanup(); } else { captchaA.value=""; } }
  function cancel(){ captchaOverlay.classList.remove('show'); cleanup(); onOk&&onOk(); }
  function cleanup(){ captchaOk.removeEventListener('click', ok); captchaCancel.removeEventListener('click', cancel); }
  captchaOk.addEventListener('click', ok); captchaCancel.addEventListener('click', cancel);
}

/* ===== ì´ë²¤íŠ¸(í–‰ìš´ì˜ ì¹´ë“œ) ===== */
const EVENTS=[
  {name:'ì´ììœ¨ -0.2% (10ì´ˆ)', run:()=>{ const old=loansTaken; loansTaken=Math.max(0, loansTaken-3); setTimeout(()=>{ loansTaken=old; updateUI(); },10000); }},
  {name:'ë³´ìœ ê¸ˆ Ã—1.5', run:()=>{ const d=Math.floor(balance*0.5); applyDelta(+d,'í–‰ìš´ì˜ ì¹´ë“œ: ë³´ìœ ê¸ˆ Ã—1.5',{countWL:false}); }},
  {name:'ì‹¤íŒ¨ í™•ë¥  0% (5ì´ˆ)', run:()=>{ const old=failureBias; failureBias=-0.46; setTimeout(()=>{ failureBias=old; updateUI(); },5000); }},
  {name:'ë³´ìœ ê¸ˆ -20%', run:()=>{ const d=Math.floor(balance*0.2); applyDelta(-d,'ì¹´ë“œ íŒ¨ë„í‹°',{countWL:false,pill:'lose'}); }},
  {name:'ì­íŒŸ ì¦ê°€ìœ¨ +20% (15ì´ˆ)', run:()=>{ const old=JACKPOT_GROWTH; JACKPOT_GROWTH*=1.2; setTimeout(()=>{ JACKPOT_GROWTH=old; },15000); }},
];
function openEvent(){
  eventChoices.innerHTML=""; eventOverlay.classList.add('show');
  // 2ê°œ ëœë¤ ë…¸ì¶œ
  const pool=[...EVENTS].sort(()=>Math.random()-0.5).slice(0,2);
  pool.forEach(ev=>{
    const b=document.createElement('button'); b.className='btn-rand'; b.textContent=ev.name; b.onclick=()=>{ ev.run(); eventOverlay.classList.remove('show'); };
    eventChoices.appendChild(b);
  });
}
// ì¼ì • ì‹œê°„ë§ˆë‹¤ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
setInterval(()=>{ if(Math.random()<0.18){ openEvent(); } }, 30000);

/* ===== ìŠ¤í‚¬ì¹´ë“œ (100íšŒë§ˆë‹¤) ===== */
const SKILLS=[
  {name:'ì„±ê³µí™•ë¥  +1%', run:()=>{ upLevel++; updateUI(); }},
  {name:'ì­íŒŸí™•ë¥  +0.05%', run:()=>{ jpLevel+=0.5; updateUI(); }},
  {name:'10ì´ˆê°„ ì­íŒŸ í™•ë¥  +2%', run:()=>{ jackpotModeUntil=Date.now()+10000; save(); updateUI(); }},
  {name:'íŒŒì‚° 1íšŒ ë°©ì–´', run:()=>{ shieldBankruptcy++; updateUI(); }},
  {name:'1ë¶„ê°„ ì‹¤íŒ¨í•´ë„ ëˆ ê°ì†Œ ì—†ìŒ', run:()=>{ noLoseUntil=Date.now()+60000; updateUI(); }},
  {name:'ì¦‰ì‹œ 20ë§Œì› íšë“', run:()=>{ applyDelta(+200000,'ìŠ¤í‚¬ ë³´ìƒ',{countWL:false}); }},
  {name:'ë‹¤ìŒë²ˆ ìŠ¤í‚¬ì¹´ë“œ íš¨ê³¼ 3ë°°', run:()=>{ nextSkillTriple=Date.now()+120000; }},
  {name:'ì­íŒŸ ê¸ˆì•¡ 4ë°°', run:()=>{ jackpot*=4; updateUI(); pushLog('ìŠ¤í‚¬','ì­íŒŸ 4ë°°','win'); }},
  {name:'ì­íŒŸ ì¦ê°€ìœ¨ 10% ì¦ê°€(30ì´ˆ)', run:()=>{ const old=JACKPOT_GROWTH; JACKPOT_GROWTH*=1.1; setTimeout(()=>{ JACKPOT_GROWTH=old; },30000); }},
  {name:'ì—­ì­íŒŸ 1íšŒ ë°©ì–´', run:()=>{ shieldReverse++; updateUI(); }},
];
function openSkillCards(){
  skillChoices.innerHTML=""; skillOverlay.classList.add('show');
  // 3ê°œ ëœë¤ ì œì‹œ
  const picks=[...SKILLS].sort(()=>Math.random()-0.5).slice(0,3);
  picks.forEach(sk=>{
    const b=document.createElement('button'); b.className='btn-rand'; b.textContent=sk.name; b.onclick=()=>{
      let times=1; if(Date.now()<nextSkillTriple){ times=3; nextSkillTriple=0; pushLog('ìŠ¤í‚¬','3ë°° ë°œë™','win'); }
      for(let i=0;i<times;i++) sk.run();
      skillOverlay.classList.remove('show'); updateUI();
    };
    skillChoices.appendChild(b);
  });
}

/* ===== ì´ˆê¸°í™”(ì¿¨íƒ€ì„/ë¦¬ìŠ¤ë„ˆ ì •ë¦¬) ===== */
function openResetPanel(){
  const lastTs = +(localStorage.getItem(KEY.RST_TS)||0);
  const left = Math.max(0, Math.ceil((lastTs + RESET_COOLDOWN_SEC*1000 - Date.now())/1000));
  resetCooldownHint.style.display = left>0 ? 'block' : 'none';
  resetCooldownHint.textContent = left>0 ? `ì´ˆê¸°í™” ì¿¨íƒ€ì„: ${left}ì´ˆ ë‚¨ìŒ` : '';
  resetInput.value = ""; resetDo.disabled = true; resetBar.style.width = "0%"; resetPanel.style.display = "block";
  let t=0; const dur=3000; const start=performance.now();
  let interval; function tick(now){ t = Math.min(1, (now-start)/dur); resetBar.style.width = (t*100).toFixed(1)+"%"; if(t<1) requestAnimationFrame(tick); }
  requestAnimationFrame(tick);
  function maybeEnable(){ const okWord = resetInput.value.trim().toUpperCase()==="RESET"; const noCooldown = (+(localStorage.getItem(KEY.RST_TS)||0) + RESET_COOLDOWN_SEC*1000 - Date.now()) <= 0; resetDo.disabled = !(okWord && t>=1 && noCooldown); }
  resetInput.addEventListener('input', maybeEnable);
  interval = setInterval(maybeEnable, 250);
  resetDo.onclick = ()=>{ resetPanel.style.display="none"; localStorage.setItem(KEY.RST_TS, String(Date.now())); doReset(); clearInterval(interval); };
  resetCancel.onclick = ()=>{ resetPanel.style.display="none"; clearInterval(interval); };
}
function doReset(){
  balance=START_BAL; peak=0; minbal=0; wins=0; losses=0;
  jackpot=baseJackpot(); upLevel=0; jpLevel=0; 
  loanPrincipal=0; loansTaken=0; if(loanTimer){ clearInterval(loanTimer); loanTimer=null; }
  playCount=0; shieldReverse=0; shieldBankruptcy=0; noLoseUntil=0; jackpotModeUntil=0; failureBias=0; rewardBoost=1.0;
  [$("#result"),$("#coinResult"),$("#hlResult"),$("#slotResult"),$("#rouletteResult"),$("#rouletteSpin"),$("#ladderResult")].forEach(el=>el.classList.remove("show"));
  r1.textContent=r2.textContent=r3.textContent="-";
  updateUI(); pushLog("ì‹œìŠ¤í…œ",`ì´ˆê¸°í™”(ì‹œì‘ê¸ˆì•¡ â‚© ${fmt(START_BAL)}, ì­íŒŸ/í™•ë¥ /ë‚œì´ë„ ë¦¬ì…‹)`,`neutral`);
  balanceHistory=[]; drawChart();
}
$("#resetBtn").addEventListener("click", openResetPanel);

/* ===== ê²Œì„ ê³µí†µ ë³´ìƒ ê³„ì‚° ===== */
function winPayout(base){ return Math.floor(base * rewardBoost); }

/* ===== í™€ì§ ===== */
function oddEvenPlay(kind){
  if(Date.now() < lastGlobalDisable) return;
  bumpPlay();
  const amount=betAmt();
  const win=rng(pWin());
  applyDelta(win?+winPayout(amount):-amount, `í™€ì§(${kind})`);
  resultDiv.classList.add("show");
  resultDiv.textContent=`${kind} ì„ íƒ â€” ${win?'ìŠ¹ë¦¬ +'+fmt(winPayout(amount)):'íŒ¨ë°° -'+fmt(amount)}`;
  jackpotChecks("í™€ì§");
}
$("#oddBtn").addEventListener("click",()=>oddEvenPlay("í™€"));
$("#evenBtn").addEventListener("click",()=>oddEvenPlay("ì§"));

/* ===== ë™ì „ ===== */
function coinFlip(choice){
  if(Date.now() < lastGlobalDisable) return;
  bumpPlay();
  if(coinSpinTimer){ clearInterval(coinSpinTimer); coinSpinTimer=null; }
  const faces=["H","T"]; let current = faces[Math.floor(Math.random()*2)];
  coinFace.classList.remove("anim"); void coinFace.offsetWidth; coinFace.classList.add("anim");
  coinFace.querySelector('.coin-face').textContent = (current==="H"?"ì•":"ë’¤");

  const totalMs=900, step=95; const start=performance.now();
  coinSpinTimer = setInterval(()=>{
    current = faces[Math.floor(Math.random()*2)];
    coinFace.querySelector('.coin-face').textContent = (current==="H"?"ì•":"ë’¤");
    if(performance.now()-start >= totalMs-step){
      clearInterval(coinSpinTimer); coinSpinTimer=null;
      const final = rng(pWin()) ? choice : (choice==="H"?"T":"H");
      coinFace.querySelector('.coin-face').textContent = (final==="H"?"ì•":"ë’¤");
      const amt=betAmt(); const win = final===choice;
      applyDelta(win?+winPayout(amt):-amt, `ë™ì „(${choice==="H"?"ì•":"ë’¤"})`);
      coinRes.classList.add("show"); coinRes.textContent=`ê²°ê³¼: ${final==="H"?"ì•":"ë’¤"} â€” ${win?'ìŠ¹ë¦¬ +'+fmt(winPayout(amt)):'íŒ¨ë°° -'+fmt(amt)}`;
      jackpotChecks("ë™ì „");
    }
  }, step);
}
$("#coinH").addEventListener("click",()=>coinFlip("H"));
$("#coinT").addEventListener("click",()=>coinFlip("T"));

/* ===== í•˜ì´/ë¡œìš° ===== */
function odometerRoll(final){
  return new Promise(resolve=>{
    let n=1, last=performance.now(); odo.textContent="â€”";
    function step(ts){ const dt=ts-last; if(dt>18){ n = Math.min(final, n + Math.max(1, Math.floor(final/28))); odo.textContent=String(n); last=ts; }
      if(n<final) requestAnimationFrame(step); else resolve(); }
    requestAnimationFrame(step);
  });
}
async function highLow(pick){
  if(Date.now() < lastGlobalDisable) return;
  bumpPlay();
  const win = rng(pWin()); let n;
  if(pick==="HIGH"){ n = win ? (51 + Math.floor(Math.random()*50)) : (1 + Math.floor(Math.random()*50)); }
  else{ n = win ? (1 + Math.floor(Math.random()*50)) : (51 + Math.floor(Math.random()*50)); }
  await odometerRoll(n);
  const amt=betAmt(); applyDelta(win?+winPayout(amt):-amt, `í•˜ì´ë¡œìš°(${pick})`);
  hlRes.classList.add("show"); hlRes.textContent=`ìˆ«ì ${n} â€” ${win?'ìŠ¹ë¦¬ +'+fmt(winPayout(amt)):'íŒ¨ë°° -'+fmt(amt)}`;
  jackpotChecks("í•˜ì´ë¡œìš°");
}
$("#lowBtn").addEventListener("click",()=>highLow("LOW"));
$("#highBtn").addEventListener("click",()=>highLow("HIGH"));

/* ===== ì‚¬ë‹¤ë¦¬ ===== */
function drawLadder(ctx,w,h,rungs){
  ctx.clearRect(0,0,w,h);
  const themeLight = document.body.classList.contains('theme-light');
  ctx.strokeStyle= themeLight ? "#111" : "#cbd7f1"; ctx.lineWidth=2;
  const margin=20, top=20, bottom=h-20; const xs=[margin, w-margin];
  ctx.beginPath(); xs.forEach(x=>{ ctx.moveTo(x,top); ctx.lineTo(x,bottom); }); ctx.stroke();
  ctx.strokeStyle="#2b8cff"; ctx.lineWidth=3;
  rungs.forEach(y=>{ ctx.beginPath(); ctx.moveTo(xs[0],y); ctx.lineTo(xs[1],y); ctx.stroke(); });
}
function genRungs(h, wantSameSide){
  const top=20, bottom=h-20;
  let N = Math.floor(3 + Math.random()*4); // 3~6
  if(wantSameSide){ if(N%2===1) N++; } else { if(N%2===0) N++; }
  const ys=[]; const minGap=18;
  while(ys.length<N){ const y = top + Math.random()*(bottom-top); if(ys.every(py => Math.abs(py - y) >= minGap)) ys.push(y); }
  ys.sort((a,b)=>a-b); return ys;
}
function ladderAnim(choice){
  return new Promise(resolve=>{
    const ctx=ladderCanvas.getContext('2d');
    const w=ladderCanvas.width, h=ladderCanvas.height;
    const margin=20, top=20, bottom=h-20, xs=[margin, w-margin];

    const win = rng(pWin());
    const wantSame = win; const rungs = genRungs(h, wantSame);
    drawLadder(ctx,w,h,rungs);

    ctx.lineWidth=4; ctx.strokeStyle="#f6d36b";
    let side = (choice==="LEFT")?0:1; let y = top; let i=0;
    function drawTo(y1, xFrom, xTo){ ctx.beginPath(); ctx.moveTo(xFrom,y); ctx.lineTo(xTo,y1); ctx.stroke(); y = y1; }
    function step(){
      if(i < rungs.length){ const targetY = rungs[i]; setTimeout(()=>{ drawTo(targetY, xs[side], xs[side]); setTimeout(()=>{ drawTo(targetY, xs[side], xs[1-side]); side = 1 - side; i++; requestAnimationFrame(step); }, 160); }, 220); }
      else{ setTimeout(()=>{ drawTo(bottom, xs[side], xs[side]); ctx.fillStyle="#f6d36b"; ctx.beginPath(); ctx.arc(xs[side], bottom, 5, 0, Math.PI*2); ctx.fill(); resolve({win, endSide: side===0?"LEFT":"RIGHT"}); }, 220); }
    }
    requestAnimationFrame(step);
  });
}
async function ladderPlay(choice){
  if(Date.now() < lastGlobalDisable) return;
  bumpPlay();
  ladderBtns.forEach(b=>setBtnDisabled(b,true));
  const {win, endSide} = await ladderAnim(choice);
  const amt=betAmt();
  applyDelta(win?+winPayout(amt):-amt, `ì‚¬ë‹¤ë¦¬(${choice})`);
  ladderRes.classList.add("show"); ladderRes.textContent = `${endSide} ë„ì°© â€” ${win?`ì„±ê³µ +${fmt(winPayout(amt))}`:`ì‹¤íŒ¨ -${fmt(amt)}`}`;
  jackpotChecks("ì‚¬ë‹¤ë¦¬");
  ladderBtns.forEach(b=>setBtnDisabled(b,false));
}
$("#ladderLeft").addEventListener("click",()=>ladderPlay("LEFT"));
$("#ladderRight").addEventListener("click",()=>ladderPlay("RIGHT"));

/* ===== ìŠ¬ë¡¯ (ê°•í™” ë°°ë‹¹) ===== */
const SYMS=["ì²´ë¦¬","ì¢…","ë³„","7","ë ˆëª¬"];
function easeOutCubic(t){ return 1 - Math.pow(1-t,3); }
function spinReel(el, {totalMs, delayMs=0, baseStep=50, slowStep=200, plateauMs=0}){
  let idx = Math.floor(Math.random()*SYMS.length);
  let last=performance.now(); const start=last + delayMs;
  return new Promise(resolve=>{
    function tick(now){
      if(now < start){ requestAnimationFrame(tick); return; }
      const elapsed = now - start; const accelMs = Math.max(0, totalMs - plateauMs);
      const p = clamp(elapsed / Math.max(1,accelMs), 0, 1);
      const stepMs = (elapsed < accelMs) ? baseStep + (slowStep - baseStep) * easeOutCubic(p) : slowStep;
      if(now - last >= stepMs){ el.textContent = SYMS[idx % SYMS.length]; el.classList.toggle('sym-7', el.textContent==="7"); idx++; last = now; }
      if(elapsed < totalMs){ requestAnimationFrame(tick); } else { resolve(el.textContent); }
    }
    requestAnimationFrame(tick);
  });
}
function playSlot(){
  if(Date.now() < lastGlobalDisable) return;
  bumpPlay();
  if(slotBusy) return; slotBusy=true; slotRes.classList.remove("show");
  const p1 = spinReel(r1, { totalMs:740,  delayMs:0,   baseStep:6,   slowStep:95,  plateauMs:0   });
  const p2 = spinReel(r2, { totalMs:1100, delayMs:130, baseStep:38,  slowStep:170, plateauMs:120 });
  const p3 = spinReel(r3, { totalMs:1750, delayMs:450, baseStep:105, slowStep:460, plateauMs:820 });

  Promise.all([p1,p2,p3]).then(([A,B,C])=>{
    const base = betAmt();
    if(A==="7" && B==="7" && C==="7"){
      const prize = Math.floor(base * 100); // 777 ì­íŒŸ Ã—100
      applyDelta(+prize, "ìŠ¬ë¡¯ ì­íŒŸ");
      slotRes.classList.add("show");
      slotRes.textContent = `ì­íŒŸ! +${fmt(prize)} (Ã—100)`;
      jackpotFX("pos");
      jackpotChecks('ìŠ¬ë¡¯', base);
      slotBusy=false; return;
    }
    let mult = 0; let text="";
    if(A===B && B===C){ mult = 75; text = '3ê°œ ì¼ì¹˜ Ã—75'; }
    else if(A===B || A===C || B===C){ mult = 4; text = '2ê°œ ì¼ì¹˜ Ã—4'; }
    const delta = (mult>0) ? Math.floor(base*mult) : -base*30; // ë¬´ë°°ë‹¹ ì†ì‹¤ 30ë°°
    applyDelta(delta>0?+delta:-base*30, "ìŠ¬ë¡¯");
    slotRes.classList.add("show");
    slotRes.textContent = `ê²°ê³¼: ${A} | ${B} | ${C} â€” ${mult>0?`ìŠ¹ë¦¬ ${text} +${fmt(delta)}`:`íŒ¨ë°° -${fmt(base*30)}`}`;
    jackpotChecks("ìŠ¬ë¡¯", base);
    slotBusy=false;
  });
}
$("#slotBtn").addEventListener("click", playSlot);

/* ===== ë£°ë › ===== */
const REDS=new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]);
function colorOf(n){ return n===0?"GREEN":(REDS.has(n)?"RED":"BLACK"); }
function sampleNumberByColor(c){ if(c==="GREEN") return 0; if(c==="RED"){ const arr=[...REDS]; return arr[Math.floor(Math.random()*arr.length)]; } const blacks=[...Array(37).keys()].filter(n=>n!==0 && !REDS.has(n)); return blacks[Math.floor(Math.random()*blacks.length)]; }
function rouletteSpinToN(n, onDone){
  rouSpin.classList.add("show");
  const seq = Array.from({length:37},(_,k)=>k);
  const start=performance.now(); let i=0, last=start; const dur=1000;
  function tick(now){
    const p=easeOutCubic(clamp((now-start)/dur,0,1));
    const stepMs = 22 + 90*p;
    if(now - last >= stepMs){ const num=seq[i%seq.length]; const c=colorOf(num)[0]; rouSpin.textContent=`ìŠ¤í•€: ${num} (${c})`; i++; last=now; }
    if(now-start<dur) requestAnimationFrame(tick); else { const col=colorOf(n); rouSpin.textContent=`ê²°ê³¼: ${n} ${col}`; onDone&&onDone(n,col); }
  }
  requestAnimationFrame(tick);
}
$$('[data-roulette]').forEach(btn=>btn.addEventListener("click",()=>{
  if(Date.now() < lastGlobalDisable) return;
  bumpPlay();
  const pick=btn.dataset.roulette; const win = rng(pWin());
  const targetColor = win ? pick : (pick==="RED"?"BLACK":"RED");
  const n = sampleNumberByColor(targetColor); const amt=betAmt();
  rouletteSpinToN(n, (_n, col)=>{
    const ok=(col===pick);
    applyDelta(ok?+winPayout(amt):-amt,`ë£°ë ›(${pick})`);
    rouRes.classList.add("show"); rouRes.textContent=`${ok?'ìŠ¹ë¦¬ +'+fmt(winPayout(amt)):'íŒ¨ë°° -'+fmt(amt)}`;
    jackpotChecks("ë£°ë ›(ìƒ‰)");
  });
}));
$("#rouletteNumBtn").addEventListener("click",()=>{
  if(Date.now() < lastGlobalDisable) return;
  bumpPlay();
  const val=+$("#rouletteNum").value; if(Number.isNaN(val)||val<0||val>36){ rouRes.classList.add("show"); rouRes.textContent="0~36 ìˆ«ìë¥¼ ë„£ì–´ì£¼ì„¸ìš”"; return; }
  const n=Math.floor(Math.random()*37), col=colorOf(n); const amt=betAmt();
  rouletteSpinToN(n, ()=>{
    const win=(val===n);
    applyDelta(win?+Math.floor(winPayout(amt)*35):-amt, `ë£°ë ›(ìˆ«ì ${val})`);
    rouRes.classList.add("show"); rouRes.textContent= win ? `ëŒ€ìŠ¹ +${fmt(Math.floor(winPayout(amt)*35))}` : `íŒ¨ë°° -${fmt(amt)}`;
    jackpotChecks("ë£°ë ›(ìˆ«ì)");
  });
});

/* ===== ì—…ì  ===== */
let achievements=new Set();
function checkAchievements(){
  if(balance>=1_000_000) achievements.add('ë°±ë§Œì¥ì');
  if(wins>=50) achievements.add('ì—°ìŠ¹ ì¥ì¸');
  if(playCount>=600) achievements.add('ì² ì¸');
  achEl.textContent = achievements.size;
}

/* ===== ë¶€íŒ… ===== */
load(); if(!Number.isFinite(jackpot) || jackpot<=0) jackpot = baseJackpot(); updateUI(); recordBalancePoint(); if(loanPrincipal>0) startLoanTimer();

/* ===== ê°€ì‹œì„± ì „í™˜ ì‹œ FX ì œì–´ ===== */
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) FX.stop(); else if(fxToggle.checked) FX.start(); });

}
</script></body>
</html>